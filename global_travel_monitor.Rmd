---
title: "Global Travel Advisory Monitor (With Memory)"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
if (!require("pacman")) install.packages("pacman")
pacman::p_load(tidyRSS, tidyverse, telegram.bot, lubridate, stringr, readr)


TELEGRAM_BOT_TOKEN <- Sys.getenv("TELEGRAM_BOT_TOKEN")
MY_CHAT_ID         <- Sys.getenv("MY_CHAT_ID")
bot <- Bot(token = TELEGRAM_BOT_TOKEN)


# ==============================================================================
# ê¸€ë¡œë²Œ ì•ˆì „ ë“±ê¸‰ ëª¨ë‹ˆí„°ë§ (ì´ì „ ê¸°ë¡ê³¼ ë¹„êµ)
# ==============================================================================
print(paste("ğŸŒ [Global Watch]", Sys.time(), "ì—¬í–‰ ê²½ë³´ ìŠ¤ìº” ë° ë¹„êµ ì¤‘..."))

feed_url <- "[http://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/jcr:content/par/feed.rss](http://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/jcr:content/par/feed.rss)"
csv_file <- "travel_status_memory.csv" # ê¸°ë¡ì„ ì €ì¥í•  íŒŒì¼ëª…

tryCatch({
  # 1. í˜„ì¬ ë°ì´í„° ìˆ˜ì§‘
  feed <- tidyRSS::tidyfeed(feed_url)
  
  current_data <- feed %>%
    select(item_title, item_link) %>%
    mutate(
      Country = str_trim(str_extract(item_title, "^.*?(?=\\s-\\sLevel)")),
      Level_Num = as.numeric(str_extract(item_title, "(?<=Level\\s)[0-9]")),
      Level_Text = str_trim(str_extract(item_title, "(?<=Level\\s).*"))
    ) %>%
    filter(!is.na(Country) & !is.na(Level_Num)) %>%
    select(Country, Level_Num, Level_Text, item_link)

  # 2. ê³¼ê±° ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° (CSV íŒŒì¼ì´ ìˆìœ¼ë©´ ì½ìŒ)
  if (file.exists(csv_file)) {
    past_data <- read_csv(csv_file, show_col_types = FALSE)
    
    # 3. ë¹„êµ ë¡œì§ (Join)
    comparison <- current_data %>%
      inner_join(past_data, by = "Country", suffix = c("_new", "_old")) %>%
      filter(Level_Num_new != Level_Num_old) # ë“±ê¸‰ ìˆ«ìê°€ ë°”ë€ ê²ƒë§Œ ì¶”ì¶œ
      
    # 4. ë³€í™” ê°ì§€ ë° ì•Œë¦¼
    if (nrow(comparison) > 0) {
      
      for(i in 1:nrow(comparison)) {
        row <- comparison[i, ]
        
        # ë³€í™” ë°©í–¥ íŒë‹¨
        if (row$Level_Num_new > row$Level_Num_old) {
          status <- "ğŸš¨ ìœ„í—˜ ì¦ê°€ (Worsened)"
          emoji <- "ğŸ“‰"
        } else {
          status. <- "âœ… ìƒí™© í˜¸ì „ (Improved)"
          emoji <- "ğŸ“ˆ"
        }
        
        msg <- paste0(
          "ğŸ‡ºğŸ‡¸ [ì—¬í–‰ê²½ë³´ ë³€ê²½ ê°ì§€]\n\n",
          "ğŸ³ï¸ êµ­ê°€: ", row$Country, "\n",
          emoji, " ìƒíƒœ: ", status, "\n",
          "ğŸ”¢ ë“±ê¸‰ ë³€í™”: Lv.", row$Level_Num_old, " â¡ï¸ Lv.", row$Level_Num_new, "\n",
          "ğŸ“ ë‚´ìš©: ", row$Level_Text_new, "\n",
          "ğŸ”— ìƒì„¸: ", row$item_link_new
        )
        
        try(bot$sendMessage(chat_id = MY_CHAT_ID, text = msg))
        Sys.sleep(1)
      }
      print(paste("âœ… ë³€ê²½ ì‚¬í•­", nrow(comparison), "ê±´ ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ"))
      
    } else {
      print("   -> ë“±ê¸‰ ë³€ë™ ì‚¬í•­ ì—†ìŒ.")
    }
    
  } else {
    print("   -> [ì´ˆê¸°í™”] ê³¼ê±° ë°ì´í„° íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œ ìƒì„±í•©ë‹ˆë‹¤.")
  }
  
  # 5. í˜„ì¬ ë°ì´í„°ë¥¼ íŒŒì¼ë¡œ ì €ì¥ (ë‹¤ìŒ ì‹¤í–‰ì„ ìœ„í•´ ì—…ë°ì´íŠ¸)
  write_csv(current_data, csv_file)
  print(paste("ğŸ’¾ í˜„ì¬ ìƒíƒœ ì €ì¥ ì™„ë£Œ:", csv_file))

}, error = function(e) {
  print(paste("Error:", e$message))
})


