---
title: "Travel Monitor via Google Sheets"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
if (!require("pacman")) install.packages("pacman")
pacman::p_load(googlesheets4, tidyverse, telegram.bot, lubridate, stringr)


TELEGRAM_BOT_TOKEN <- Sys.getenv("TELEGRAM_BOT_TOKEN")
MY_CHAT_ID         <- Sys.getenv("MY_CHAT_ID")
bot <- Bot(token = TELEGRAM_BOT_TOKEN)


# ==============================================================================
# êµ¬ê¸€ ì‹œíŠ¸ ì—°ë™ ì—¬í–‰ê²½ë³´ ëª¨ë‹ˆí„°ë§
# ==============================================================================
print(paste("ğŸ“Š [Sheet Monitor]", Sys.time(), "êµ¬ê¸€ ì‹œíŠ¸ ë°ì´í„° í™•ì¸ ì¤‘..."))

# 1. êµ¬ê¸€ ì‹œíŠ¸ ì£¼ì†Œ (ë³¸ì¸ì˜ ì‹œíŠ¸ ì£¼ì†Œë¡œ êµì²´í•˜ì„¸ìš”!)
sheet_url <- "[https://docs.google.com/spreadsheets/d/YOUR_SHEET_ID_HERE/edit](https://docs.google.com/spreadsheets/d/YOUR_SHEET_ID_HERE/edit)"

# [í•µì‹¬] ì¸ì¦ ì—†ì´ ì½ê¸° ëª¨ë“œë¡œ ì„¤ì • (ê³µìœ  ë§í¬ê°€ ìˆì–´ì•¼ í•¨)
gs4_deauth()

tryCatch({
  # 2. ë°ì´í„° ì½ê¸°
  # IFTTTê°€ ì±„ìš°ëŠ” ì‹œíŠ¸ëŠ” í—¤ë”ê°€ ì—†ì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ col_names = FALSE
  raw_data <- read_sheet(sheet_url, col_names = FALSE)
  
  # 3. ë°ì´í„° ì •ë¦¬ (IFTTT í¬ë§·ì— ë”°ë¼ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ)
  # ê°€ì •: Aì—´=ì œëª©(êµ­ê°€+ë ˆë²¨), Bì—´=ë§í¬, Cì—´=ë‚ ì§œ
  clean_data <- raw_data %>%
    rename(Title = ...1, Link = ...2, Date_Str = ...3) %>%
    mutate(
      # ë‚ ì§œ íŒŒì‹± (IFTTT ë‚ ì§œ í˜•ì‹ì— ë§ì¶° ìˆ˜ì • í•„ìš”í•  ìˆ˜ ìˆìŒ)
      # ì˜ˆ: "November 24, 2025 at 10:30PM" -> mdy_hm() ë“±ì´ í•„ìš”
      # ì—¬ê¸°ì„œëŠ” ë‹¨ìˆœíˆ ì‹œìŠ¤í…œ ì‹œê°„ê³¼ ë¹„êµí•˜ê¸° ìœ„í•´ ìµœê·¼ ìƒìœ„ í–‰ë§Œ ë´…ë‹ˆë‹¤.
      Row_Index = row_number()
    ) %>%
    head(10) # ìµœì‹  10ê°œë§Œ ë¶„ì„

  # 4. "ìƒˆë¡œìš´ ì •ë³´" íŒë‹¨ ë¡œì§
  # (ê°€ì¥ ê°„ë‹¨í•œ ë°©ë²•: ìµœê·¼ 24ì‹œê°„ ë‚´ ì‹¤í–‰ëœ ì ì´ ìˆë‹¤ë©´, ìƒìœ„ Nê°œê°€ ìƒˆ ê¸€ì¼ ê²ƒì„)
  # ì—¬ê¸°ì„œëŠ” "ì˜¤ëŠ˜ ë‚ ì§œ"ê°€ í¬í•¨ëœ ë°ì´í„°ê°€ ìˆëŠ”ì§€ í…ìŠ¤íŠ¸ë¡œ ê²€ìƒ‰í•©ë‹ˆë‹¤.
  
  today_pattern <- format(Sys.time(), "%B %d, %Y") # ì˜ˆ: November 25, 2025
  
  new_entries <- clean_data %>%
    filter(str_detect(Date_Str, today_pattern)) # ë‚ ì§œ í…ìŠ¤íŠ¸ ë§¤ì¹­
    
  if (nrow(new_entries) > 0) {
    print(paste("âœ… ì˜¤ëŠ˜ ë‚ ì§œ(", today_pattern, ") ë°ì´í„° ë°œê²¬:", nrow(new_entries), "ê±´"))
    
    for(i in 1:nrow(new_entries)) {
      title <- new_entries$Title[i]
      link  <- new_entries$Link[i]
      
      # êµ­ê°€ëª…ê³¼ ë ˆë²¨ ì¶”ì¶œ
      country <- str_extract(title, "^.*?(?=\\s-\\sLevel)")
      level   <- str_extract(title, "Level [1-4]")
      
      msg <- paste0(
        "ğŸ‡ºğŸ‡¸ [êµ¬ê¸€ì‹œíŠ¸ ê°ì§€ ì•Œë¦¼]\n\n",
        "ğŸ³ï¸ êµ­ê°€: ", country, "\n",
        "ğŸ“¢ ë“±ê¸‰: ", level, "\n",
        "ğŸ”— ë§í¬: ", link
      )
      
      try(bot$sendMessage(chat_id = MY_CHAT_ID, text = msg))
      Sys.sleep(1)
    }
  } else {
    print("   -> ì˜¤ëŠ˜ ë‚ ì§œë¡œ ì—…ë°ì´íŠ¸ëœ ë‚´ì—­ ì—†ìŒ.")
    # ìƒì¡´ ì‹ ê³ 
    try(bot$sendMessage(chat_id = MY_CHAT_ID, text = "âœ… [êµ¬ê¸€ì‹œíŠ¸ ì ê²€] ì˜¤ëŠ˜ ì¶”ê°€ëœ ì—¬í–‰ ê²½ë³´ ì—†ìŒ."))
  }

}, error = function(e) {
  print(paste("âŒ êµ¬ê¸€ ì‹œíŠ¸ ì½ê¸° ì‹¤íŒ¨:", e$message))
})
