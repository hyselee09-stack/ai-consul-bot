---
title: "Global Travel Monitor (Sheet Import Method)"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
if (!require("pacman")) install.packages("pacman")
pacman::p_load(googlesheets4, tidyverse, telegram.bot, lubridate, stringr, readr)


TELEGRAM_BOT_TOKEN <- Sys.getenv("TELEGRAM_BOT_TOKEN")
MY_CHAT_ID         <- Sys.getenv("MY_CHAT_ID")
bot <- Bot(token = TELEGRAM_BOT_TOKEN)


print(paste("ğŸ“Š [Sheet Monitor]", Sys.time(), "êµ¬ê¸€ ì‹œíŠ¸ ë°ì´í„°(IMPORTFEED) í™•ì¸ ì¤‘..."))

# [ì¤‘ìš”] IMPORTFEED í•¨ìˆ˜ê°€ ì íŒ êµ¬ê¸€ ì‹œíŠ¸ ì£¼ì†Œ
sheet_url <- "[https://docs.google.com/spreadsheets/d/YOUR_SHEET_ID_HERE](https://docs.google.com/spreadsheets/d/YOUR_SHEET_ID_HERE)" 
csv_file  <- "travel_status_memory.csv"

# ì¸ì¦ ì—†ì´ ì½ê¸° ëª¨ë“œ
gs4_deauth()

tryCatch({
  # 1. êµ¬ê¸€ ì‹œíŠ¸ ì½ê¸°
  # IMPORTFEEDë¡œ ê°€ì ¸ì˜¨ ë°ì´í„°ëŠ” ì»¬ëŸ¼ ì´ë¦„ì´ ë³´í†µ Title, Author, URL, Date... ìˆœì„œì„
  raw_data <- read_sheet(sheet_url)
  
  if (nrow(raw_data) == 0) {
    print("âš ï¸ ì‹œíŠ¸ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.")
  } else {
    
    # 2. ë°ì´í„° ì •ë¦¬
    current_data <- raw_data %>%
      select(1, 3, 4) %>% # ì œëª©(Title), URL, ë‚ ì§œ(Date Created) ì—´ ì„ íƒ
      rename(Title = 1, Link = 2, Date_Raw = 3) %>%
      mutate(
        Country = str_trim(str_extract(Title, "^.*?(?=\\s-\\sLevel)")),
        Level_Num = as.numeric(str_extract(Title, "(?<=Level\\s)[0-9]")),
        Level_Text = str_trim(str_extract(Title, "(?<=Level\\s).*"))
      ) %>%
      filter(!is.na(Country) & !is.na(Level_Num)) %>%
      select(Country, Level_Num, Level_Text, Link)

    print(paste("âœ… ë°ì´í„° ë¡œë“œ ì„±ê³µ: ì´", nrow(current_data), "ê°œêµ­"))

    # 3. ê³¼ê±° ê¸°ë¡(CSV)ê³¼ ë¹„êµ (ë³€í™” ê°ì§€)
    if (file.exists(csv_file)) {
      past_data <- read_csv(csv_file, show_col_types = FALSE)
      
      comparison <- current_data %>%
        inner_join(past_data, by = "Country", suffix = c("_new", "_old")) %>%
        filter(Level_Num_new != Level_Num_old)
        
      if (nrow(comparison) > 0) {
        for(i in 1:nrow(comparison)) {
          row <- comparison[i, ]
          
          if (row$Level_Num_new > row$Level_Num_old) {
             emoji <- "ğŸ“‰ (ì•…í™”)"
             status_msg <- "ìœ„í—˜ ì¦ê°€"
          } else {
             emoji <- "ğŸ“ˆ (í˜¸ì „)"
             status_msg <- "ìƒí™© ê°œì„ "
          }
          
          msg <- paste0(
            "ğŸ‡ºğŸ‡¸ [ì—¬í–‰ê²½ë³´ ë³€ê²½]\n\n",
            "ğŸ³ï¸ êµ­ê°€: ", row$Country, "\n",
            emoji, " ìƒíƒœ: ", status_msg, "\n",
            "ğŸ”¢ ë“±ê¸‰: Lv.", row$Level_Num_old, " â¡ï¸ Lv.", row$Level_Num_new, "\n",
            "ğŸ“ ë‚´ìš©: ", row$Level_Text_new, "\n",
            "ğŸ”— ë§í¬: ", row$Link_new
          )
          
          try(bot$sendMessage(chat_id = MY_CHAT_ID, text = msg))
          Sys.sleep(1)
        }
        print(paste("âœ… ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ:", nrow(comparison), "ê±´"))
      } else {
        print("   -> ë³€ë™ ì‚¬í•­ ì—†ìŒ.")
      }
    } else {
      print("   -> [ì´ˆê¸°í™”] ì²« ì‹¤í–‰. ê¸°ì¤€ ë°ì´í„° ì €ì¥.")
      try(bot$sendMessage(chat_id = MY_CHAT_ID, text = "âœ… [ì—¬í–‰ê²½ë³´] êµ¬ê¸€ ì‹œíŠ¸ ì—°ë™ ì´ˆê¸°í™” ì™„ë£Œ."))
    }
    
    # 4. í˜„ì¬ ìƒíƒœ ì €ì¥ (ë‹¤ìŒ ë¹„êµë¥¼ ìœ„í•´)
    write_csv(current_data, csv_file)
    print("ğŸ’¾ ë°ì´í„° ì €ì¥ ì™„ë£Œ")
  }

}, error = function(e) {
  print(paste("âŒ ì—ëŸ¬ ë°œìƒ:", e$message))
})
