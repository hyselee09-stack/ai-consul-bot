---
title: "Consular Protection Monitor (Southwest US)"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# 1. ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ (ì„¤ì¹˜ ì•ˆ ëœ ê²½ìš° ìë™ ì„¤ì¹˜)
if (!require("pacman")) install.packages("pacman")
pacman::p_load(httr, jsonlite, tidyRSS, tidyverse, telegram.bot, rvest, lubridate, purrr)

# ==============================================================================
# 2. ë³´ì•ˆ ì„¤ì •: GitHub Secretsì—ì„œ ë¹„ë°€ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸°
# (ì£¼ì˜: ì´ íŒŒì¼ì— ì ˆëŒ€ ì§„ì§œ í‚¤ë¥¼ ì ì§€ ë§ˆì„¸ìš”!)
# ==============================================================================
GEMINI_API_KEY     <- Sys.getenv("GEMINI_API_KEY")
TELEGRAM_BOT_TOKEN <- Sys.getenv("TELEGRAM_BOT_TOKEN")
MY_CHAT_ID         <- Sys.getenv("MY_CHAT_ID")

# [ì„¤ì •] ì‚¬ìš©í•  ëª¨ë¸ëª…
MODEL_NAME         <- "gemini-2.5-flash"

# í…”ë ˆê·¸ë¨ ë´‡ ì´ˆê¸°í™”
bot <- Bot(token = TELEGRAM_BOT_TOKEN)

# ==============================================================================
# 3. í•µì‹¬ í•¨ìˆ˜ ì •ì˜
# ==============================================================================

# [í•¨ìˆ˜ 1] ì œë¯¸ë‚˜ì´ ì§ì ‘ í˜¸ì¶œ (ìˆ˜ë™ API ìš”ì²­)
ask_gemini_direct <- function(prompt) {
  url <- paste0("[https://generativelanguage.googleapis.com/v1beta/models/](https://generativelanguage.googleapis.com/v1beta/models/)", MODEL_NAME, ":generateContent?key=", GEMINI_API_KEY)
  
  body_data <- list(
    contents = list(list(parts = list(list(text = prompt))))
  )
  
  tryCatch({
    response <- POST(
      url, 
      add_headers("Content-Type" = "application/json"), 
      body = toJSON(body_data, auto_unbox = TRUE)
    )
    
    if (status_code(response) == 200) {
      result_json <- fromJSON(content(response, "text", encoding = "UTF-8"))
      return(result_json$candidates$content$parts[[1]]$text)
    } else {
      print(paste("âš ï¸ API Error Code:", status_code(response)))
      return(NULL)
    }
  }, error = function(e) {
    print("âš ï¸ ì œë¯¸ë‚˜ì´ í†µì‹  ì‹¤íŒ¨")
    return(NULL)
  })
}

# [í•¨ìˆ˜ 2] ë‰´ìŠ¤ ë³¸ë¬¸ ìŠ¤í¬ë˜í•‘
get_full_text <- function(link) {
  tryCatch({
    page <- read_html(link, options = "NO_ERROR")
    text <- page %>% html_nodes("p") %>% html_text() %>% paste(collapse = " ")
    if (nchar(text) < 100) return(NULL)
    return(substr(text, 1, 2000))
  }, error = function(e) { return(NULL) })
}

# [í•¨ìˆ˜ 3] ë‰´ìŠ¤ ìˆ˜ì§‘ (ë²”ìœ„ í™•ì¥: CA, NV, AZ, NM)
fetch_news <- function() {
  
  # 1. Google News US (ì˜ì–´) - 4ê°œ ì£¼ í†µí•© ê²€ìƒ‰
  # ì¿¼ë¦¬: (CA OR NV OR AZ OR NM) AND (ì‚¬ê³  í‚¤ì›Œë“œ)
  url_google_us <- "[https://news.google.com/rss/search?q=(California+OR+Nevada+OR+Arizona+OR+%22New+Mexico%22)+(accident+OR+disaster+OR+shooting+OR+crash+OR+death)+when:1h&ceid=US:en&hl=en-US&gl=US](https://news.google.com/rss/search?q=(California+OR+Nevada+OR+Arizona+OR+%22New+Mexico%22)+(accident+OR+disaster+OR+shooting+OR+crash+OR+death)+when:1h&ceid=US:en&hl=en-US&gl=US)"
  
  # 2. ë¯¸ì£¼ ì¤‘ì•™ì¼ë³´ (LA ì‚¬íšŒë©´ - ì„œë¶€ ê±°ì )
  url_joongang <- "[https://rss.koreadaily.com/la/society.xml](https://rss.koreadaily.com/la/society.xml)"
  
  # 3. ë¼ë””ì˜¤ì½”ë¦¬ì•„ (LA ë‰´ìŠ¤ - ì„œë¶€ ê±°ì )
  url_radiokorea <- "[https://www.radiokorea.com/rss/news_news.xml](https://www.radiokorea.com/rss/news_news.xml)"
  
  # 4. êµ¬ê¸€ ë‰´ìŠ¤ í•œêµ­ì–´íŒ (ë¡œì»¬ í•œì¸ ì–¸ë¡ ì‚¬ í¬ê´„ ê²€ìƒ‰)
  # íŠ¹ì • ì‹ ë¬¸ì‚¬ ì‚¬ì´íŠ¸ë§Œ ì§€ì •í•˜ëŠ” ëŒ€ì‹ , 4ê°œ ì£¼ ì´ë¦„ì„ í‚¤ì›Œë“œë¡œ ê²€ìƒ‰í•˜ì—¬ 
  # 'ë¼ìŠ¤ë² ê°€ìŠ¤ í•œêµ­ì¼ë³´', 'ì•„ë¦¬ì¡°ë‚˜ íƒ€ì„ì¦ˆ' ë“± ëª¨ë“  ë¡œì»¬ ë§¤ì²´ë¥¼ ì¡ì•„ëƒ…ë‹ˆë‹¤.
  url_korean_regional <- "[https://news.google.com/rss/search?q=(ìº˜ë¦¬í¬ë‹ˆì•„+OR+ë„¤ë°”ë‹¤+OR+ì• ë¦¬ì¡°ë‚˜+OR+ë‰´ë©•ì‹œì½”)+(ì‚¬ê±´+OR+ì‚¬ê³ +OR+í™”ì¬+OR+ì´ê²©+OR+ì‚¬ë§)+when:1h&ceid=KR:ko&hl=ko&gl=KR](https://news.google.com/rss/search?q=(ìº˜ë¦¬í¬ë‹ˆì•„+OR+ë„¤ë°”ë‹¤+OR+ì• ë¦¬ì¡°ë‚˜+OR+ë‰´ë©•ì‹œì½”)+(ì‚¬ê±´+OR+ì‚¬ê³ +OR+í™”ì¬+OR+ì´ê²©+OR+ì‚¬ë§)+when:1h&ceid=KR:ko&hl=ko&gl=KR)"

  safe_fetch <- function(url, src) {
    tryCatch({
      feed <- tidyRSS::tidyfeed(url)
      if (nrow(feed) > 0) {
        feed %>% 
          select(item_title, item_link, item_description, item_pub_date) %>% 
          mutate(source = src) %>% 
          head(5) # ì†ŒìŠ¤ë‹¹ ìµœì‹  5ê°œ
      } else { NULL }
    }, error = function(e) { return(NULL) })
  }
  
  bind_rows(
    safe_fetch(url_google_us, "Google_US"),
    safe_fetch(url_joongang, "Joongang_LA"),
    safe_fetch(url_radiokorea, "Radio_Korea"),
    safe_fetch(url_korean_regional, "Korean_Regional")
  )
}

# ==============================================================================
# 4. ë©”ì¸ ì‹¤í–‰ ë¡œì§ (Southwest US Monitor)
# ==============================================================================
print(paste("ğŸ“¡ [GitHub Action]", Sys.time(), "ë‰´ìŠ¤ ì²´í¬ ì‹œì‘ (Target: CA, NV, AZ, NM)"))

news_data <- fetch_news()
alert_count <- 0

if (is.null(news_data) || nrow(news_data) == 0) {
  print("   -> ìˆ˜ì§‘ëœ ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.")
  try(bot$sendMessage(chat_id = MY_CHAT_ID, text = "âœ… [ì ê²€] ìˆ˜ì§‘ëœ ìƒˆ ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤. (ì‹œìŠ¤í…œ ì •ìƒ)"))
  
} else {
  
  # [ì¤‘ìš”] ìµœê·¼ 40ë¶„ ì´ë‚´ ê¸°ì‚¬ë§Œ í•„í„°ë§
  current_time <- Sys.time()
  news_data <- news_data %>%
    mutate(pub_date_parsed = ymd_hms(item_pub_date)) %>%
    filter(pub_date_parsed >= (current_time - minutes(40)))
  
  if (nrow(news_data) > 0) {
    print(paste("   ->", nrow(news_data), "ê°œì˜ ìµœì‹  ê¸°ì‚¬ë¥¼ ë¶„ì„í•©ë‹ˆë‹¤."))
    
    for(i in 1:nrow(news_data)) {
      title <- news_data$item_title[i]; link <- news_data$item_link[i]; desc <- news_data$item_description[i]; src <- news_data$source[i]
      
      # ë³¸ë¬¸ ê¸ê¸° ì‹œë„
      full_text <- get_full_text(link)
      content_src <- if(is.null(full_text)) gsub("<.*?>", "", desc) else full_text
      
      # í”„ë¡¬í”„íŠ¸ ì—…ë°ì´íŠ¸ (4ê°œ ì£¼ ë°˜ì˜)
      prompt <- paste0(
        "Analyze this news.\n Source: ", src, "\n Title: ", title, "\n Content: ", content_src, "\n\n",
        
        "YOUR TASK: Act as a Consul. Identify negative incidents (crime, accident, disaster) involving Koreans in Southwest US (California, Nevada, Arizona, New Mexico).\n",
        
        "CRITERIA:\n",
        "1. Korean Media (Joongang, RadioKorea, Korean_Regional):\n",
        "   -> Check if it is a negative incident. (Ignore ads, general good news).\n",
        "2. Google US (English):\n",
        "   -> Check for Korean names (Kim, Lee, Park), Korean locations (Koreatown), or Korean businesses.\n",
        "   -> Check if the location is in CA, NV, AZ, or NM.\n\n",
        
        "OUTPUT FORMAT (Strictly):\n",
        "'Major: [Yes/No] | Korean: [Yes/No] | Reason: [Short logic] | Summary: [1 sentence Korean]'"
      )
      
      Sys.sleep(4)
      analysis <- ask_gemini_direct(prompt)
      
      # ë¶„ì„ ê²°ê³¼ ì²˜ë¦¬
      if (!is.null(analysis) && str_detect(analysis, "Korean: Yes")) {
        summary <- str_extract(analysis, "(?<=Summary: ).*")
        reason <- str_extract(analysis, "(?<=Reason: ).*(?=\\| Summary)")
        msg <- paste0("ğŸš¨ [ê¸´ê¸‰] í•œì¸ ê´€ë ¨ ì‚¬ê±´ (", src, ")\n\nğŸ“Œ ", title, "\nğŸ§ ", reason, "\nğŸ“ ", summary, "\nğŸ”— ", link)
        
        tryCatch({
          bot$sendMessage(chat_id = MY_CHAT_ID, text = msg)
          print(paste("âœ… ì•Œë¦¼ ì „ì†¡:", title))
          alert_count <- alert_count + 1
        }, error = function(e) { print("ì „ì†¡ ì‹¤íŒ¨") })
      }
    }
    
    # ìƒì¡´ ì‹ ê³  (íŠ¹ì´ì‚¬í•­ ì—†ì„ ë•Œ)
    if (alert_count == 0) {
      safe_msg <- paste0("âœ… [ì ê²€] 4ê°œ ì£¼(CA, NV, AZ, NM) ë‰´ìŠ¤ ", nrow(news_data), "ê±´ í™•ì¸ ê²°ê³¼, í•œì¸ ê´€ë ¨ íŠ¹ì´ì‚¬í•­ ì—†ìŠµë‹ˆë‹¤.")
      try(bot$sendMessage(chat_id = MY_CHAT_ID, text = safe_msg))
    }

  } else {
    print("   -> ìµœê·¼ 40ë¶„ ë‚´ ìƒˆë¡œìš´ ê¸°ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤.")
    try(bot$sendMessage(chat_id = MY_CHAT_ID, text = "âœ… [ì ê²€] ìµœê·¼ 40ë¶„ ë‚´ ë°œìƒí•œ ìƒˆ ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤."))
  }
}
