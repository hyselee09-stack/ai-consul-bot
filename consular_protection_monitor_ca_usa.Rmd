---
title: "Consular Protection Monitor (Korean Focus)"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
if (!require("pacman")) install.packages("pacman")
pacman::p_load(httr, jsonlite, tidyRSS, tidyverse, telegram.bot, rvest, lubridate, purrr)


GEMINI_API_KEY     <- Sys.getenv("GEMINI_API_KEY")
TELEGRAM_BOT_TOKEN <- Sys.getenv("TELEGRAM_BOT_TOKEN")
MY_CHAT_ID         <- Sys.getenv("MY_CHAT_ID")
MODEL_NAME         <- "gemini-2.5-flash"
bot <- Bot(token = TELEGRAM_BOT_TOKEN)


ask_gemini_direct <- function(prompt) {
  url <- paste0("[https://generativelanguage.googleapis.com/v1beta/models/](https://generativelanguage.googleapis.com/v1beta/models/)", MODEL_NAME, ":generateContent?key=", GEMINI_API_KEY)
  body_data <- list(contents = list(list(parts = list(list(text = prompt)))))
  tryCatch({
    response <- POST(url, add_headers("Content-Type" = "application/json"), body = toJSON(body_data, auto_unbox = TRUE))
    if (status_code(response) == 200) {
      result_json <- fromJSON(content(response, "text", encoding = "UTF-8"))
      return(result_json$candidates$content$parts[[1]]$text)
    } else { return(NULL) }
  }, error = function(e) { return(NULL) })
}

get_full_text <- function(link) {
  tryCatch({
    page <- read_html(link, options = "NO_ERROR")
    text <- page %>% html_nodes("p") %>% html_text() %>% paste(collapse = " ")
    if (nchar(text) < 100) return(NULL)
    return(substr(text, 1, 2000))
  }, error = function(e) { return(NULL) })
}

fetch_news <- function() {
  # Google US: 4ê°œ ì£¼ í†µí•© ê²€ìƒ‰
  url_google_us <- "[https://news.google.com/rss/search?q=(California+OR+Nevada+OR+Arizona+OR+%22New+Mexico%22)+(accident+OR+disaster+OR+shooting+OR+crash+OR+death)+when:1h&ceid=US:en&hl=en-US&gl=US](https://news.google.com/rss/search?q=(California+OR+Nevada+OR+Arizona+OR+%22New+Mexico%22)+(accident+OR+disaster+OR+shooting+OR+crash+OR+death)+when:1h&ceid=US:en&hl=en-US&gl=US)"
  # ë¯¸ì£¼ ì¤‘ì•™ì¼ë³´ (LA)
  url_joongang <- "[https://rss.koreadaily.com/la/society.xml](https://rss.koreadaily.com/la/society.xml)"
  # ë¼ë””ì˜¤ì½”ë¦¬ì•„
  url_radiokorea <- "[https://www.radiokorea.com/rss/news_news.xml](https://www.radiokorea.com/rss/news_news.xml)"
  # êµ¬ê¸€ í•œêµ­ì–´ (ë¡œì»¬ í•œì¸ ì–¸ë¡  í¬ê´„)
  url_korean_regional <- "[https://news.google.com/rss/search?q=(ìº˜ë¦¬í¬ë‹ˆì•„+OR+ë„¤ë°”ë‹¤+OR+ì• ë¦¬ì¡°ë‚˜+OR+ë‰´ë©•ì‹œì½”)+(ì‚¬ê±´+OR+ì‚¬ê³ +OR+í™”ì¬+OR+ì´ê²©+OR+ì‚¬ë§)+when:1h&ceid=KR:ko&hl=ko&gl=KR](https://news.google.com/rss/search?q=(ìº˜ë¦¬í¬ë‹ˆì•„+OR+ë„¤ë°”ë‹¤+OR+ì• ë¦¬ì¡°ë‚˜+OR+ë‰´ë©•ì‹œì½”)+(ì‚¬ê±´+OR+ì‚¬ê³ +OR+í™”ì¬+OR+ì´ê²©+OR+ì‚¬ë§)+when:1h&ceid=KR:ko&hl=ko&gl=KR)"

  safe_fetch <- function(url, src) {
    tryCatch({
      feed <- tidyRSS::tidyfeed(url)
      if (nrow(feed) > 0) {
        feed %>% select(item_title, item_link, item_description, item_pub_date) %>% mutate(source = src) %>% head(5)
      } else { NULL }
    }, error = function(e) { return(NULL) })
  }
  
  bind_rows(
    safe_fetch(url_google_us, "Google_US"),
    safe_fetch(url_joongang, "Joongang_LA"),
    safe_fetch(url_radiokorea, "Radio_Korea"),
    safe_fetch(url_korean_regional, "Korean_Regional")
  )
}


print(paste("ğŸ“¡ [Korean Monitor]", Sys.time(), "ë‰´ìŠ¤ ì²´í¬ ì‹œì‘"))
news_data <- fetch_news()
alert_count <- 0

if (is.null(news_data) || nrow(news_data) == 0) {
  try(bot$sendMessage(chat_id = MY_CHAT_ID, text = "âœ… [í•œì¸ ë³´í˜¸] ìˆ˜ì§‘ëœ ìƒˆ ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤. (ì‹œìŠ¤í…œ ì •ìƒ)"))
} else {
  # ìµœê·¼ 40ë¶„ í•„í„°ë§
  current_time <- Sys.time()
  news_data <- news_data %>%
    mutate(pub_date_parsed = ymd_hms(item_pub_date)) %>%
    filter(pub_date_parsed >= (current_time - minutes(40)))
  
  if (nrow(news_data) > 0) {
    for(i in 1:nrow(news_data)) {
      title <- news_data$item_title[i]; link <- news_data$item_link[i]; desc <- news_data$item_description[i]; src <- news_data$source[i]
      full_text <- get_full_text(link)
      content_src <- if(is.null(full_text)) gsub("<.*?>", "", desc) else full_text
      
      prompt <- paste0(
        "Analyze this news.\n Source: ", src, "\n Title: ", title, "\n Content: ", content_src, "\n\n",
        "YOUR TASK: Act as a Consul. Identify negative incidents (crime, accident, disaster) involving Koreans in Southwest US (CA, NV, AZ, NM).\n",
        "CRITERIA:\n 1. Korean Media: Check if negative incident.\n 2. Google US: Check Korean names/locations/businesses in CA/NV/AZ/NM.\n",
        "OUTPUT: 'Major: [Yes/No] | Korean: [Yes/No] | Reason: [Short logic] | Summary: [1 sentence Korean]'"
      )
      
      Sys.sleep(4)
      analysis <- ask_gemini_direct(prompt)
      
      if (!is.null(analysis) && str_detect(analysis, "Korean: Yes")) {
        summary <- str_extract(analysis, "(?<=Summary: ).*")
        reason <- str_extract(analysis, "(?<=Reason: ).*(?=\\| Summary)")
        msg <- paste0("ğŸš¨ [ê¸´ê¸‰] í•œì¸ ê´€ë ¨ ì‚¬ê±´ (", src, ")\n\nğŸ“Œ ", title, "\nğŸ§ ", reason, "\nğŸ“ ", summary, "\nğŸ”— ", link)
        try({
          bot$sendMessage(chat_id = MY_CHAT_ID, text = msg)
          alert_count <- alert_count + 1
        })
      }
    }
    if (alert_count == 0) {
      try(bot$sendMessage(chat_id = MY_CHAT_ID, text = paste0("âœ… [í•œì¸ ë³´í˜¸] ", nrow(news_data), "ê±´ í™•ì¸. íŠ¹ì´ì‚¬í•­ ì—†ìŒ.")))
    }
  } else {
    try(bot$sendMessage(chat_id = MY_CHAT_ID, text = "âœ… [í•œì¸ ë³´í˜¸] ìµœê·¼ 40ë¶„ ë‚´ ìƒˆ ë‰´ìŠ¤ ì—†ìŒ."))
  }
}



