---
title: "Consular Protection Monitor"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# 1. ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ (ì„¤ì¹˜ ì•ˆ ëœ ê²½ìš° ìë™ ì„¤ì¹˜)
if (!require("pacman")) install.packages("pacman")
pacman::p_load(httr, jsonlite, tidyRSS, tidyverse, telegram.bot, rvest, lubridate, purrr)

# ==============================================================================
# 2. ë³´ì•ˆ ì„¤ì •: GitHub Secretsì—ì„œ ë¹„ë°€ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸°
# (ì£¼ì˜: ì´ íŒŒì¼ì— ì ˆëŒ€ ì§„ì§œ í‚¤ë¥¼ ì ì§€ ë§ˆì„¸ìš”!)
# ==============================================================================
GEMINI_API_KEY     <- Sys.getenv("GEMINI_API_KEY")
TELEGRAM_BOT_TOKEN <- Sys.getenv("TELEGRAM_BOT_TOKEN")
MY_CHAT_ID         <- Sys.getenv("MY_CHAT_ID")

# [ì„¤ì •] ì‚¬ìš©í•  ëª¨ë¸ëª… (ìš”ì²­í•˜ì‹  2.5 Flash)
MODEL_NAME         <- "gemini-2.5-flash"

# í…”ë ˆê·¸ë¨ ë´‡ ì´ˆê¸°í™”
bot <- Bot(token = TELEGRAM_BOT_TOKEN)

# ==============================================================================
# 3. í•µì‹¬ í•¨ìˆ˜ ì •ì˜
# ==============================================================================

# [í•¨ìˆ˜ 1] ì œë¯¸ë‚˜ì´ ì§ì ‘ í˜¸ì¶œ (ìˆ˜ë™ API ìš”ì²­)
ask_gemini_direct <- function(prompt) {
  url <- paste0("https://generativelanguage.googleapis.com/v1beta/models/", MODEL_NAME, ":generateContent?key=", GEMINI_API_KEY)
  
  body_data <- list(
    contents = list(list(parts = list(list(text = prompt))))
  )
  
  tryCatch({
    response <- POST(
      url, 
      add_headers("Content-Type" = "application/json"), 
      body = toJSON(body_data, auto_unbox = TRUE)
    )
    
    if (status_code(response) == 200) {
      result_json <- fromJSON(content(response, "text", encoding = "UTF-8"))
      return(result_json$candidates$content$parts[[1]]$text)
    } else {
      print(paste("âš ï¸ API Error Code:", status_code(response)))
      return(NULL)
    }
  }, error = function(e) {
    print("âš ï¸ ì œë¯¸ë‚˜ì´ í†µì‹  ì‹¤íŒ¨")
    return(NULL)
  })
}

# [í•¨ìˆ˜ 2] ë‰´ìŠ¤ ë³¸ë¬¸ ìŠ¤í¬ë˜í•‘ (ì œëª©ë§Œ ë³´ëŠ” í•œê³„ ê·¹ë³µ)
get_full_text <- function(link) {
  tryCatch({
    # íƒ€ì„ì•„ì›ƒ ì˜µì…˜ ì¶”ê°€í•˜ì—¬ ë©ˆì¶¤ ë°©ì§€
    page <- read_html(link, options = "NO_ERROR")
    # <p> íƒœê·¸ë§Œ ê¸ì–´ì˜¤ê¸°
    text <- page %>% html_nodes("p") %>% html_text() %>% paste(collapse = " ")
    
    # ë„ˆë¬´ ì§§ìœ¼ë©´(ë´‡ ì°¨ë‹¨ ë“±) NULL ë°˜í™˜, ê¸¸ë©´ 2000ìë§Œ ìë¦„
    if (nchar(text) < 100) return(NULL)
    return(substr(text, 1, 2000))
  }, error = function(e) {
    return(NULL) 
  })
}

# [í•¨ìˆ˜ 3] ë‰´ìŠ¤ ìˆ˜ì§‘ (ì˜ì–´ + í•œêµ­ì–´ 4ëŒ€ ì†ŒìŠ¤)
fetch_news <- function() {
  # 1. Google News US (ì˜ì–´)
  url_google_us <- "https://news.google.com/rss/search?q=California+(accident+OR+disaster+OR+shooting+OR+crash)+when:1h&ceid=US:en&hl=en-US&gl=US"
  # 2. ë¯¸ì£¼ ì¤‘ì•™ì¼ë³´ (LA ì‚¬íšŒ)
  url_joongang <- "https://rss.koreadaily.com/la/society.xml"
  # 3. ë¼ë””ì˜¤ì½”ë¦¬ì•„ (ë¡œì»¬ ë‰´ìŠ¤)
  url_radiokorea <- "https://www.radiokorea.com/rss/news_news.xml"
  # 4. ë¯¸ì£¼ í•œêµ­ì¼ë³´ (êµ¬ê¸€ ìš°íšŒ)
  url_hankook <- "https://news.google.com/rss/search?q=site:koreatimes.com+California+(ì‚¬ê±´+OR+ì‚¬ê³ +OR+í™”ì¬+OR+ì´ê²©)+when:1h&ceid=KR:ko&hl=ko&gl=KR"

  safe_fetch <- function(url, src) {
    tryCatch({
      feed <- tidyRSS::tidyfeed(url)
      if (nrow(feed) > 0) {
        feed %>% 
          select(item_title, item_link, item_description, item_pub_date) %>% 
          mutate(source = src) %>% 
          head(5) # ì†ŒìŠ¤ë‹¹ ìµœì‹  5ê°œ
      } else { NULL }
    }, error = function(e) { return(NULL) })
  }
  
  bind_rows(
    safe_fetch(url_google_us, "Google_US"),
    safe_fetch(url_joongang, "Joongang_Ilbo"),
    safe_fetch(url_radiokorea, "Radio_Korea"),
    safe_fetch(url_hankook, "Hankook_Ilbo")
  )
}

# ==============================================================================
# 4. ë©”ì¸ ì‹¤í–‰ ë¡œì§
# ==============================================================================
print(paste("ğŸ“¡ [GitHub Action]", Sys.time(), "ë‰´ìŠ¤ ì²´í¬ ì‹œì‘ (Model:", MODEL_NAME, ")"))

news_data <- fetch_news()

if (is.null(news_data) || nrow(news_data) == 0) {
  print("   -> ìˆ˜ì§‘ëœ ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.")
} else {
  
  # [ì¤‘ìš”] ìµœê·¼ 40ë¶„ ì´ë‚´ ê¸°ì‚¬ë§Œ í•„í„°ë§ (ì¤‘ë³µ ì•Œë¦¼ ë°©ì§€)
  current_time <- Sys.time()
  news_data <- news_data %>%
    mutate(pub_date_parsed = ymd_hms(item_pub_date)) %>%
    filter(pub_date_parsed >= (current_time - minutes(40)))
  
  if (nrow(news_data) > 0) {
    print(paste("   ->", nrow(news_data), "ê°œì˜ ìµœì‹  ê¸°ì‚¬ë¥¼ ë¶„ì„í•©ë‹ˆë‹¤."))
    
    for(i in 1:nrow(news_data)) {
      title <- news_data$item_title[i]
      link  <- news_data$item_link[i]
      desc  <- news_data$item_description[i]
      src   <- news_data$source[i]
      
      # ë³¸ë¬¸ ê¸ê¸° ì‹œë„
      full_text <- get_full_text(link)
      
      if (is.null(full_text)) {
        content_src <- gsub("<.*?>", "", desc) # HTML íƒœê·¸ ì œê±°
        source_type <- "Summary Only"
      } else {
        content_src <- full_text
        source_type <- "Full Text Scraped"
      }
      
      # ì œë¯¸ë‚˜ì´ í”„ë¡¬í”„íŠ¸ (ì§€ë¦¬ì /ì—…ì¢… í”„ë¡œíŒŒì¼ë§ í¬í•¨)
      prompt <- paste0(
        "Analyze this news.\n",
        "Source: ", src, "\n",
        "Title: ", title, "\n",
        "Content (", source_type, "): ", content_src, "\n\n",
        
        "YOUR TASK: Act as a Crisis Monitoring Officer. Identify negative incidents (crime, accident, disaster) involving Koreans/Korean-Americans in California.\n",
        
        "CRITERIA:\n",
        "1. IF Source is 'Joongang_Ilbo', 'Radio_Korea', or 'Hankook_Ilbo':\n",
        "   -> It is ALREADY Korean-related. Just check if it is a negative incident (Ignore ads, politics, festivals).\n",
        "2. IF Source is 'Google_US':\n",
        "   -> Look for Korean names (Kim, Lee, Park, Choi), Locations (Koreatown, Zion Market, H-Mart), or Business types (Liquor store, Dry cleaner, Donut shop).\n\n",
        
        "OUTPUT FORMAT (Strictly):\n",
        "'Major: [Yes/No] | Korean: [Yes/No] | Reason: [Short explanation] | Summary: [1 sentence in Korean]'"
      )
      
      # API í˜¸ì¶œ (ì†ë„ ì¡°ì ˆ 4ì´ˆ)
      Sys.sleep(4)
      analysis <- ask_gemini_direct(prompt)
      
      # ê²°ê³¼ ì²˜ë¦¬ ë° ì•Œë¦¼ ë°œì†¡
      if (!is.null(analysis) && str_detect(analysis, "Korean: Yes")) {
        
        summary <- str_extract(analysis, "(?<=Summary: ).*")
        reason  <- str_extract(analysis, "(?<=Reason: ).*(?=\\| Summary)")
        
        msg <- paste0(
          "ğŸš¨ [ê¸´ê¸‰] í•œì¸ ê´€ë ¨ ì‚¬ê±´ ê°ì§€!\n\n",
          "ğŸ“° ì¶œì²˜: ", src, "\n",
          "ğŸ“Œ ì œëª©: ", title, "\n",
          "ğŸ§ ì´ìœ : ", reason, "\n",
          "ğŸ“ ìš”ì•½: ", summary, "\n",
          "ğŸ”— ë§í¬: ", link
        )
        
        tryCatch({
          bot$sendMessage(chat_id = MY_CHAT_ID, text = msg)
          print(paste("âœ… ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ:", title))
        }, error = function(e) {
          print(paste("âŒ í…”ë ˆê·¸ë¨ ì „ì†¡ ì‹¤íŒ¨:", title))
        })
        
      } else {
        print(paste("âšª ê´€ë ¨ ì—†ìŒ:", title))
      }
    }
  } else {
    print("   -> ìµœê·¼ 40ë¶„ ë‚´ ìƒˆë¡œìš´ ê¸°ì‚¬ê°€ ì—†ìŠµë‹ˆë‹¤.")
  }
}

