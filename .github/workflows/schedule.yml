name: Consular Protection Monitor

on:
  schedule:
    # 매시 5분, 35분마다 실행 (30분 간격)
    - cron: '5,35 * * * *'
  workflow_dispatch: # 수동 실행 버튼

jobs:
  run-monitor-rmd:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3
      
      - name: Setup R
        uses: r-lib/actions/setup-r@v2
        
      - name: Setup Pandoc
        uses: r-lib/actions/setup-pandoc@v2
      
      # [추가됨] 리눅스 시스템 라이브러리 설치 (이게 없어서 에러가 났던 겁니다)
      - name: Install Linux System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libcurl4-openssl-dev libssl-dev libxml2-dev libfontconfig1-dev libharfbuzz-dev libfribidi-dev libfreetype6-dev libpng-dev libtiff5-dev libjpeg-dev
        
      - name: Install R Packages
        # 이제 기초 공사가 되었으니 R 패키지 설치가 성공할 겁니다.
        run: |
          install.packages(c("rmarkdown", "pacman", "httr", "jsonlite", "tidyRSS", "tidyverse", "telegram.bot", "rvest", "lubridate", "purrr"), repos = "https://cloud.r-project.org")
        shell: Rscript {0}
        
      - name: Run Monitor Rmd
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          MY_CHAT_ID: ${{ secrets.MY_CHAT_ID }}
        run: Rscript -e "rmarkdown::render('consular_protection_monitor_ca_usa.Rmd')"
