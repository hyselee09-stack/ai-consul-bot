name: Daily Knowledge Base Update and Telegram Notify

on:
  schedule:
    # 매일 새벽 4시 (UTC 기준 오후 7시) 실행
    - cron: '0 19 * * *' 
  workflow_dispatch: # 수동 실행을 위한 버튼 추가

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    # ⭐⭐ 최종 해결: 403 권한 거부 문제 해결 ⭐⭐
    permissions:
      contents: write # 깃허브 봇에게 CSV 파일 갱신 권한을 부여

    env:
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      R_VERSION: '4.5' # 버전 불일치 에러 해결
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: ${{ env.R_VERSION }}

      # ⭐⭐ R 패키지 캐시 (속도 최적화) ⭐⭐
      - name: Cache R packages
        uses: actions/cache@v3
        with:
          path: ${{ env.R_LIBS_USER }}
          # R 버전과 OS를 키로 사용하여 캐시
          key: ${{ runner.os }}-r-${{ env.R_VERSION }}-${{ hashFiles('renv.lock', 'DESCRIPTION') }}
          restore-keys: |
            ${{ runner.os }}-r-

      - name: Install dependencies
        # 패키지 설치 오류 수정: R -e '...' 명령으로 안정적으로 설치
        run: |
          R -e 'install.packages(c("httr", "rvest", "dplyr", "stringr", "xml2"), repos = "https://cloud.r-project.org/")'
        shell: bash

      - name: Run R script to update data
        run: Rscript update_knowledge.R

      - name: Commit and Push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'CI: Auto update G4K knowledge base [skip ci]'
          files: |
            final_chatbot_knowledge.csv
            update_knowledge.csv # G4K 데이터가 갱신되면 이 파일도 같이 커밋됩니다.
