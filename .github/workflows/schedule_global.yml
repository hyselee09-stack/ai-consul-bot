name: ğŸŒ US Global Travel Monitor Schedule

on:
  schedule:
    # ë§¤ì¼ UTC 00:00 (í•œêµ­ ì˜¤ì „ 9ì‹œ) ì‹¤í–‰
    - cron: '0 0 * * *'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ë²„íŠ¼

# [ì¤‘ìš”] ê¹ƒí—ˆë¸Œ ì €ì¥ì†Œì— CSV íŒŒì¼ì„ ì €ì¥í•  ìˆ˜ ìˆëŠ” ê¶Œí•œ ë¶€ì—¬
permissions:
  contents: write

jobs:
  run-global-monitor:
    runs-on: ubuntu-latest
    
    # [1] í™˜ê²½ë³€ìˆ˜ ì„¤ì • (ìºì‹œ ê²½ë¡œ ë° ë¹„ë°€í‚¤)
    env:
      R_LIBS_USER: ./R/library
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      MY_CHAT_ID: ${{ secrets.MY_CHAT_ID }}

    steps:
      - uses: actions/checkout@v3
      
      - uses: r-lib/actions/setup-r@v2
      
      - uses: r-lib/actions/setup-pandoc@v2
      
      # ë¦¬ëˆ…ìŠ¤ ì‹œìŠ¤í…œ ì˜ì¡´ì„± ì„¤ì¹˜ (curl ë“±)
      - name: Install Linux System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libcurl4-openssl-dev libssl-dev libxml2-dev libfontconfig1-dev libharfbuzz-dev libfribidi-dev libfreetype6-dev libpng-dev libtiff5-dev libjpeg-dev
        
      # [2] íŒ¨í‚¤ì§€ ìºì‹œ ì„¤ì • (ì†ë„ í–¥ìƒ)
      - name: Cache R Packages
        uses: actions/cache@v3
        with:
          path: ${{ env.R_LIBS_USER }}
          key: ${{ runner.os }}-r-${{ hashFiles('.github/workflows/*.yml') }}
          restore-keys: |
            ${{ runner.os }}-r-

      # [3] R íŒ¨í‚¤ì§€ ì„¤ì¹˜ (RSPM ì‚¬ìš©í•˜ì—¬ ì´ˆê³ ì† ì„¤ì¹˜)
      - name: Install R Packages
        run: |
          dir.create(Sys.getenv("R_LIBS_USER"), recursive = TRUE, showWarnings = FALSE)
          install.packages(c("rmarkdown", "pacman", "jsonlite", "tidyverse", "telegram.bot", "readr", "lubridate"), 
                           repos = "https://packagemanager.posit.co/cran/__linux__/jammy/latest", 
                           lib = Sys.getenv("R_LIBS_USER"))
        shell: Rscript {0}
        
      # [4] R ì½”ë“œ ì‹¤í–‰ (íŒŒì¼ëª…ì´ ë§ëŠ”ì§€ ê¼­ í™•ì¸í•˜ì„¸ìš”!)
      - name: Run Global Monitor Script
        run: Rscript -e "rmarkdown::render('US_global_travel_monitor.Rmd')"
      
      # [5] ê²°ê³¼ íŒŒì¼ ì €ì¥ (íŒŒì¼ì´ ìˆì„ ë•Œë§Œ ì‹¤í–‰)
      - name: Commit and Push Data
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          
          # íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ í™•ì¸ í›„ ì»¤ë°‹
          if [ -f travel_status_memory.csv ]; then
            echo "âœ… CSV file found. Committing..."
            git add travel_status_memory.csv
            git commit -m "Update travel advisory data" || echo "No changes to commit"
            git push "https://${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git" HEAD:main
          else
            echo "âš ï¸ CSV file was NOT created. Skipping commit."
          fi
