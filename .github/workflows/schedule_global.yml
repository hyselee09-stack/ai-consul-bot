---
title: "US Global Travel Advisory Monitor (Robust Scraping)"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# Load necessary packages (httr is essential for bypassing bot detection)
if (!require("pacman")) install.packages("pacman")
pacman::p_load(httr, tidyRSS, tidyverse, telegram.bot, lubridate, stringr, readr, xml2)


TELEGRAM_BOT_TOKEN <- Sys.getenv("TELEGRAM_BOT_TOKEN")
MY_CHAT_ID         <- Sys.getenv("MY_CHAT_ID")
bot <- Bot(token = TELEGRAM_BOT_TOKEN)


# Helper function for logging with timestamps
log_msg <- function(msg) {
  message(paste0("[", Sys.time(), "] ", msg))
}

log_msg("üåç [Global Watch] Starting Travel Advisory Scan...")

# [Target] US State Department Travel Advisory RSS Feed
feed_url <- "[https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/jcr:content/par/feed.rss](https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/jcr:content/par/feed.rss)"
csv_file <- "travel_status_memory.csv"

# [Critical Function] Safe Fetch to bypass 403 Forbidden & SSL errors
fetch_feed_safe <- function(url) {
  tryCatch({
    # 1. Pretend to be a browser (User-Agent Spoofing + Ignore SSL)
    response <- GET(
      url, 
      config = config(ssl_verifypeer = 0L, ssl_verifyhost = 0L), # Ignore SSL certificate errors
      add_headers(
        "User-Agent" = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",
        "Accept" = "application/rss+xml, application/xml, text/xml, */*"
      ),
      timeout(30) # Wait up to 30 seconds
    )
    
    log_msg(paste("üì° Connection Status Code:", status_code(response)))
    
    if (status_code(response) != 200) {
      log_msg("‚ö†Ô∏è Connection Failed! (Blocked or Server Error)")
      return(NULL)
    }
    
    # 2. Parse the content
    content_text <- content(response, "text", encoding = "UTF-8")
    return(tidyRSS::tidyfeed(content_text))
    
  }, error = function(e) {
    log_msg(paste("‚ö†Ô∏è Network/Parsing Error:", e$message))
    return(NULL)
  })
}

# --- Main Execution Logic ---

# 1. Fetch Data Safely
feed <- fetch_feed_safe(feed_url)

if (!is.null(feed) && nrow(feed) > 0) {
  log_msg(paste("‚úÖ Data fetch successful! Found", nrow(feed), "items."))
  
  # 2. Clean and Process Data
  current_data <- feed %>%
    select(item_title, item_link) %>%
    mutate(
      Country = str_trim(str_extract(item_title, "^.*?(?=\\s-\\sLevel)")),
      Level_Num = as.numeric(str_extract(item_title, "(?<=Level\\s)[0-9]")),
      Level_Text = str_trim(str_extract(item_title, "(?<=Level\\s).*"))
    ) %>%
    filter(!is.na(Country) & !is.na(Level_Num)) %>%
    select(Country, Level_Num, Level_Text, item_link)

  # 3. Compare with Previous Data (If exists)
  if (file.exists(csv_file)) {
    past_data <- read_csv(csv_file, show_col_types = FALSE)
    
    comparison <- current_data %>%
      inner_join(past_data, by = "Country", suffix = c("_new", "_old")) %>%
      filter(Level_Num_new != Level_Num_old) 
      
    if (nrow(comparison) > 0) {
      for(i in 1:nrow(comparison)) {
        row <- comparison[i, ]
        
        # Determine Direction of Change
        if (row$Level_Num_new > row$Level_Num_old) {
           emoji <- "üìâ"
           status_msg <- "Risk Increased (Worsened)"
        } else {
           emoji <- "üìà"
           status_msg <- "Situation Improved"
        }
        
        # Compose Telegram Message
        msg <- paste0(
          "üá∫üá∏ [Travel Advisory Update]\n\n",
          "üè≥Ô∏è Country: ", row$Country, "\n",
          emoji, " Status: ", status_msg, "\n",
          "üî¢ Level: Lv.", row$Level_Num_old, " ‚û°Ô∏è Lv.", row$Level_Num_new, "\n",
          "üîó Link: ", row$item_link_new
        )
        
        try(bot$sendMessage(chat_id = MY_CHAT_ID, text = msg))
        Sys.sleep(1)
      }
      log_msg(paste("‚úÖ Sent alerts for", nrow(comparison), "changed countries."))
    } else {
      log_msg("-> No changes in safety levels.")
    }
  } else {
    log_msg("-> [Init] First run. Creating initial data file.")
    try(bot$sendMessage(chat_id = MY_CHAT_ID, text = "‚úÖ [Travel Monitor] Initial data collection complete."))
  }
  
  # 4. Save Current Data (Only if fetch was successful)
  write_csv(current_data, csv_file)
  log_msg(paste("üíæ Data saved to:", csv_file))

} else {
  log_msg("‚ùå Final Failure: Could not fetch data. File will not be updated.")
}
