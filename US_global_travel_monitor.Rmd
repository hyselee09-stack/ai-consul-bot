---
title: "Global Travel Safety Monitor (API Method)"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
if (!require("pacman")) install.packages("pacman")
# jsonlite íŒ¨í‚¤ì§€ë¡œ API ë°ì´í„°ë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤
pacman::p_load(jsonlite, tidyverse, telegram.bot, readr, lubridate)


TELEGRAM_BOT_TOKEN <- Sys.getenv("TELEGRAM_BOT_TOKEN")
MY_CHAT_ID         <- Sys.getenv("MY_CHAT_ID")
bot <- Bot(token = TELEGRAM_BOT_TOKEN)


print(paste("ğŸŒ [Global Watch]", Sys.time(), "ì•ˆì „ ì ìˆ˜ API ì¡°íšŒ ì‹œì‘..."))

# [í•µì‹¬] ë¯¸êµ­ êµ­ë¬´ë¶€ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•˜ëŠ” ì˜¤í”ˆ API ì£¼ì†Œ
api_url <- "[https://www.travel-advisory.info/api](https://www.travel-advisory.info/api)"
csv_file <- "travel_status_memory.csv"

tryCatch({
  # 1. API ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (JSON í˜•ì‹)
  json_data <- fromJSON(api_url)
  
  # 2. ë°ì´í„° ì¶”ì¶œ ë° ì •ë¦¬ (ë¦¬ìŠ¤íŠ¸ -> ë°ì´í„°í”„ë ˆì„)
  # API êµ¬ì¡°ê°€ ë³µì¡í•´ì„œ purrr::mapìœ¼ë¡œ ì •ë¦¬í•©ë‹ˆë‹¤.
  raw_list <- json_data$data
  
  current_data <- map_dfr(raw_list, function(x) {
    tibble(
      Country = x$name,
      Score = as.numeric(x$advisory$score), # 0~5ì  (ë†’ì„ìˆ˜ë¡ ìœ„í—˜)
      Update_Date = as_datetime(x$advisory$updated)
    )
  }) %>%
    select(Country, Score) %>%
    arrange(desc(Score))
  
  print(paste("âœ… API ë°ì´í„° ìˆ˜ì§‘ ì„±ê³µ! ì´", nrow(current_data), "ê°œêµ­ í™•ì¸."))

  # 3. ê³¼ê±° ë°ì´í„°ì™€ ë¹„êµ
  if (file.exists(csv_file)) {
    past_data <- read_csv(csv_file, show_col_types = FALSE)
    
    # ë¹„êµ ë¡œì§ (êµ­ê°€ëª… ê¸°ì¤€)
    comparison <- current_data %>%
      inner_join(past_data, by = "Country", suffix = c("_new", "_old")) %>%
      filter(Score_new != Score_old) # ì ìˆ˜ê°€ ë°”ë€ êµ­ê°€ë§Œ ì¶”ì¶œ
      
    if (nrow(comparison) > 0) {
      for(i in 1:nrow(comparison)) {
        row <- comparison[i, ]
        
        # ì ìˆ˜ ë³€í™” ë°©í–¥ íŒë‹¨
        diff <- row$Score_new - row$Score_old
        if (diff > 0) {
           emoji <- "ğŸ“‰ (ì•…í™”)"
           status_msg <- paste0("ìœ„í—˜ë„ ì¦ê°€ (+", round(diff, 1), ")")
        } else {
           emoji <- "ğŸ“ˆ (í˜¸ì „)"
           status_msg <- paste0("ìƒí™© ê°œì„  (", round(diff, 1), ")")
        }
        
        # ì ìˆ˜ë¥¼ ëŒ€ëµì ì¸ Levelë¡œ ë³€í™˜í•´ì„œ ë³´ì—¬ì¤Œ
        level_est <- case_when(
          row$Score_new >= 4.5 ~ "â›” ê¸ˆì§€ (Lv.4ê¸‰)",
          row$Score_new >= 3.5 ~ "ğŸŸ  ì¬ê³  (Lv.3ê¸‰)",
          row$Score_new >= 2.5 ~ "ğŸŸ¡ ì£¼ì˜ (Lv.2ê¸‰)",
          TRUE ~ "ğŸ”µ ì•ˆì „ (Lv.1ê¸‰)"
        )
        
        msg <- paste0(
          "ğŸŒ [êµ­ê°€ ì•ˆì „ì ìˆ˜ ë³€ê²½]\n\n",
          "ğŸ³ï¸ êµ­ê°€: ", row$Country, "\n",
          emoji, " ìƒíƒœ: ", status_msg, "\n",
          "ğŸ”¢ ì ìˆ˜: ", row$Score_old, " â¡ï¸ ", row$Score_new, " / 5.0\n",
          "ğŸ“Š ì¶”ì • ë“±ê¸‰: ", level_est, "\n",
          "ğŸ”— ì¶œì²˜: travel-advisory.info"
        )
        
        try(bot$sendMessage(chat_id = MY_CHAT_ID, text = msg))
        Sys.sleep(1)
      }
      print(paste("âœ… ë³€ê²½ ì‚¬í•­", nrow(comparison), "ê±´ ì•Œë¦¼ ë°œì†¡ ì™„ë£Œ."))
    } else {
      print("   -> ì ìˆ˜ ë³€ë™ ì‚¬í•­ ì—†ìŒ.")
    }
  } else {
    print("   -> [ì´ˆê¸°í™”] ì²« ì‹¤í–‰ì…ë‹ˆë‹¤. ê¸°ì¤€ ë°ì´í„°ë¥¼ ì €ì¥í•©ë‹ˆë‹¤.")
    try(bot$sendMessage(chat_id = MY_CHAT_ID, text = "âœ… [ì•ˆì „ ê°ì‹œ] ì´ˆê¸° ë°ì´í„° ìˆ˜ì§‘ ì™„ë£Œ (API ë°©ì‹)."))
  }
  
  # 4. ë°ì´í„° ì €ì¥ (ì´ê²Œ ì„±ê³µí•´ì•¼ git add ì—ëŸ¬ê°€ ì•ˆ ë‚¨)
  write_csv(current_data, csv_file)
  print(paste("ğŸ’¾ ë°ì´í„° íŒŒì¼ ì €ì¥ ì™„ë£Œ:", csv_file))

}, error = function(e) {
  print(paste("âŒ ì—ëŸ¬ ë°œìƒ:", e$message))
})
