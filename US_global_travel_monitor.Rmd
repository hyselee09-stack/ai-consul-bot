---
title: "Global Travel Monitor (System Curl Strategy)"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
if (!require("pacman")) install.packages("pacman")
pacman::p_load(jsonlite, tidyverse, telegram.bot, readr, lubridate)


TELEGRAM_BOT_TOKEN <- Sys.getenv("TELEGRAM_BOT_TOKEN")
MY_CHAT_ID         <- Sys.getenv("MY_CHAT_ID")
bot <- Bot(token = TELEGRAM_BOT_TOKEN)


print(paste("ğŸŒ [Global Watch]", Sys.time(), "ì‹œìŠ¤í…œ ë‹¤ìš´ë¡œë“œ ë°©ì‹ìœ¼ë¡œ ë°ì´í„° ìˆ˜ì§‘ ì‹œì‘..."))

# ë¯¸êµ­ êµ­ë¬´ë¶€ ë°ì´í„°ë¥¼ ë¯¸ëŸ¬ë§í•˜ëŠ” ì˜¤í”ˆ API
api_url <- "[https://www.travel-advisory.info/api](https://www.travel-advisory.info/api)"
temp_file <- "temp_api_data.json" # ì„ì‹œë¡œ ì €ì¥í•  íŒŒì¼ëª…
csv_file <- "travel_status_memory.csv"

# [í•µì‹¬ ì „ëµ] R íŒ¨í‚¤ì§€ ëŒ€ì‹  ì‹œìŠ¤í…œ ëª…ë ¹ì–´(curl)ë¡œ ê°•ì œ ë‹¤ìš´ë¡œë“œ
# -L: ë¦¬ë‹¤ì´ë ‰íŠ¸ ì¶”ì , -k: ë³´ì•ˆê²½ê³  ë¬´ì‹œ, -H: ë¸Œë¼ìš°ì €ì¸ ì²™ ìœ„ì¥
download_cmd <- paste0("curl -L -k -s -H 'User-Agent: Mozilla/5.0' -o ", temp_file, " '", api_url, "'")

# 1. ì‹œìŠ¤í…œ ëª…ë ¹ì–´ë¡œ íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì‹¤í–‰
exit_code <- system(download_cmd)

# 2. íŒŒì¼ì´ ì˜ ë°›ì•„ì¡ŒëŠ”ì§€ í™•ì¸ (ìš©ëŸ‰ì´ 100ë°”ì´íŠ¸ ì´ìƒì´ì–´ì•¼ í•¨)
if (exit_code == 0 && file.exists(temp_file) && file.info(temp_file)$size > 100) {
  print("âœ… JSON íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì„±ê³µ! ë°ì´í„° ë¶„ì„ ì‹œì‘.")
  
  tryCatch({
    # 3. ë‹¤ìš´ë¡œë“œëœ íŒŒì¼ ì½ê¸°
    json_data <- fromJSON(temp_file)
    
    # 4. ë°ì´í„° ì •ë¦¬
    raw_data <- json_data$data
    
    current_data <- map_dfr(raw_data, function(x) {
      tibble(
        Country = x$name,
        Score = as.numeric(x$advisory$score),
        Update_Date = as_datetime(x$advisory$updated)
      )
    }) %>%
      select(Country, Score) %>%
      filter(!is.na(Score))
    
    print(paste("ğŸ“Š ë°ì´í„° íŒŒì‹± ì™„ë£Œ. ì´", nrow(current_data), "ê°œêµ­ í™•ì¸."))

    # 5. ê³¼ê±° ë°ì´í„° ë¹„êµ
    if (file.exists(csv_file)) {
      past_data <- read_csv(csv_file, show_col_types = FALSE)
      
      comparison <- current_data %>%
        inner_join(past_data, by = "Country", suffix = c("_new", "_old")) %>%
        filter(Score_new != Score_old)
        
      if (nrow(comparison) > 0) {
        for(i in 1:nrow(comparison)) {
          row <- comparison[i, ]
          diff <- row$Score_new - row$Score_old
          
          if (diff > 0) {
             emoji <- "ğŸ“‰ (ì•…í™”)"
             status_msg <- paste0("ìœ„í—˜ë„ ì¦ê°€ (+", round(diff, 1), ")")
          } else {
             emoji <- "ğŸ“ˆ (í˜¸ì „)"
             status_msg <- paste0("ìƒí™© ê°œì„  (", round(diff, 1), ")")
          }
          
          # ë ˆë²¨ ì¶”ì •
          level_est <- case_when(
            row$Score_new >= 4.5 ~ "â›” ê¸ˆì§€ (Lv.4)",
            row$Score_new >= 3.5 ~ "ğŸŸ  ì¬ê³  (Lv.3)",
            row$Score_new >= 2.5 ~ "ğŸŸ¡ ì£¼ì˜ (Lv.2)",
            TRUE ~ "ğŸ”µ ì•ˆì „ (Lv.1)"
          )
          
          msg <- paste0(
            "ğŸŒ [ì•ˆì „ì ìˆ˜ ë³€ê²½]\n\n",
            "ğŸ³ï¸ êµ­ê°€: ", row$Country, "\n",
            emoji, " ìƒíƒœ: ", status_msg, "\n",
            "ğŸ”¢ ì ìˆ˜: ", row$Score_old, " â¡ï¸ ", row$Score_new, " / 5.0\n",
            "ğŸ“Š ì¶”ì •: ", level_est, "\n",
            "ğŸ”— ì¶œì²˜: travel-advisory.info"
          )
          
          try(bot$sendMessage(chat_id = MY_CHAT_ID, text = msg))
          Sys.sleep(1)
        }
        print(paste("âœ… ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ:", nrow(comparison), "ê±´"))
      } else {
        print("   -> ì ìˆ˜ ë³€ë™ ì‚¬í•­ ì—†ìŒ.")
      }
    } else {
      print("   -> [ì´ˆê¸°í™”] ì²« ì‹¤í–‰. ê¸°ì¤€ ë°ì´í„° ì €ì¥.")
      try(bot$sendMessage(chat_id = MY_CHAT_ID, text = "âœ… [ì—¬í–‰ê²½ë³´] ì‹œìŠ¤í…œ CURL ë°©ì‹ìœ¼ë¡œ ì´ˆê¸°í™” ì™„ë£Œ."))
    }
    
    # 6. íŒŒì¼ ì €ì¥ (ì´ê²Œ ì„±ê³µí•´ì•¼ git addê°€ ë¨)
    write_csv(current_data, csv_file)
    print(paste("ğŸ’¾ ë°ì´í„° ì €ì¥ ì™„ë£Œ:", csv_file))
    
  }, error = function(e) {
    print(paste("âŒ íŒŒì‹± ì—ëŸ¬:", e$message))
  })
  
} else {
  print("âŒ ìµœì¢… ì‹¤íŒ¨: CURL ë‹¤ìš´ë¡œë“œì¡°ì°¨ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ë„¤íŠ¸ì›Œí¬ ì°¨ë‹¨)")
}
