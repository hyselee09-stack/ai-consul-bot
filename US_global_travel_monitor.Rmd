---
title: "US Global Travel Advisory Monitor (System Curl)"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
if (!require("pacman")) install.packages("pacman")
pacman::p_load(tidyRSS, tidyverse, telegram.bot, lubridate, stringr, readr, xml2)


TELEGRAM_BOT_TOKEN <- Sys.getenv("TELEGRAM_BOT_TOKEN")
MY_CHAT_ID         <- Sys.getenv("MY_CHAT_ID")
bot <- Bot(token = TELEGRAM_BOT_TOKEN)


# ë¡œê·¸ í•¨ìˆ˜
log_msg <- function(msg) {
  message(paste0("[", Sys.time(), "] ", msg))
}

log_msg("ğŸŒ [Global Watch] ì‹œìŠ¤í…œ CURL ë°©ì‹ìœ¼ë¡œ ë°ì´í„° ìˆ˜ì§‘ ì‹œë„...")

# RSS ì£¼ì†Œ
feed_url <- "[https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/jcr:content/par/feed.rss](https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/jcr:content/par/feed.rss)"
temp_xml <- "temp_feed.xml"
csv_file <- "travel_status_memory.csv"

# [í•µì‹¬] ë¦¬ëˆ…ìŠ¤ ì‹œìŠ¤í…œ ëª…ë ¹ì–´(curl)ë¥¼ ì‚¬ìš©í•´ ê°•ì œ ë‹¤ìš´ë¡œë“œ
download_feed_system <- function(url, dest_file) {
  # User-Agentì™€ Refererë¥¼ ì„¤ì •í•˜ì—¬ ì™„ë²½í•˜ê²Œ ë¸Œë¼ìš°ì €ì¸ ì²™ ìœ„ì¥
  cmd <- paste0(
    "curl -L -s ",  # -L: ë¦¬ë‹¤ì´ë ‰íŠ¸ ì¶”ì , -s: ì¡°ìš©íˆ ì‹¤í–‰
    "-A 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36' ",
    "-H 'Referer: [https://www.google.com/](https://www.google.com/)' ",
    "-o ", dest_file, " ",
    "'", url, "'"
  )
  
  log_msg("ğŸ“¡ CURL ëª…ë ¹ ì‹¤í–‰ ì¤‘...")
  exit_code <- system(cmd)
  
  if (exit_code == 0 && file.exists(dest_file) && file.info(dest_file)$size > 0) {
    return(TRUE)
  } else {
    return(FALSE)
  }
}

# --- ì‹¤í–‰ ë¡œì§ ---

# 1. ì‹œìŠ¤í…œ ëª…ë ¹ì–´ë¡œ ë‹¤ìš´ë¡œë“œ ì‹œë„
if (download_feed_system(feed_url, temp_xml)) {
  log_msg("âœ… íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì„±ê³µ! ë°ì´í„° íŒŒì‹± ì‹œì‘.")
  
  tryCatch({
    # 2. ë‹¤ìš´ë¡œë“œëœ XML íŒŒì¼ ì½ê¸°
    feed <- tidyRSS::tidyfeed(temp_xml)
    
    if (nrow(feed) > 0) {
      
      # ë°ì´í„° ì •ì œ
      current_data <- feed %>%
        select(item_title, item_link) %>%
        mutate(
          Country = str_trim(str_extract(item_title, "^.*?(?=\\s-\\sLevel)")),
          Level_Num = as.numeric(str_extract(item_title, "(?<=Level\\s)[0-9]")),
          Level_Text = str_trim(str_extract(item_title, "(?<=Level\\s).*"))
        ) %>%
        filter(!is.na(Country) & !is.na(Level_Num)) %>%
        select(Country, Level_Num, Level_Text, item_link)

      # ê³¼ê±° ë°ì´í„° ë¹„êµ
      if (file.exists(csv_file)) {
        past_data <- read_csv(csv_file, show_col_types = FALSE)
        
        comparison <- current_data %>%
          inner_join(past_data, by = "Country", suffix = c("_new", "_old")) %>%
          filter(Level_Num_new != Level_Num_old) 
          
        if (nrow(comparison) > 0) {
          for(i in 1:nrow(comparison)) {
            row <- comparison[i, ]
            emoji <- ifelse(row$Level_Num_new > row$Level_Num_old, "ğŸ“‰", "ğŸ“ˆ")
            
            msg <- paste0(
              "ğŸ‡ºğŸ‡¸ [ì—¬í–‰ê²½ë³´ ë³€ê²½]\n\n",
              "ğŸ³ï¸ êµ­ê°€: ", row$Country, "\n",
              emoji, " ë“±ê¸‰: Lv.", row$Level_Num_old, " â¡ï¸ Lv.", row$Level_Num_new, "\n",
              "ğŸ”— ë§í¬: ", row$item_link_new
            )
            try(bot$sendMessage(chat_id = MY_CHAT_ID, text = msg))
            Sys.sleep(1)
          }
          log_msg(paste("âœ… ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ:", nrow(comparison), "ê±´"))
        } else {
          log_msg("-> ë³€ë™ ì‚¬í•­ ì—†ìŒ.")
        }
      } else {
        log_msg("-> [ì´ˆê¸°í™”] ì²« ì‹¤í–‰. ë°ì´í„° íŒŒì¼ ìƒì„±.")
        try(bot$sendMessage(chat_id = MY_CHAT_ID, text = "âœ… [ì—¬í–‰ê²½ë³´] ì‹œìŠ¤í…œ CURL ë°©ì‹ìœ¼ë¡œ ì´ˆê¸°í™” ì™„ë£Œ."))
      }
      
      # íŒŒì¼ ì €ì¥
      write_csv(current_data, csv_file)
      log_msg(paste("ğŸ’¾ ë°ì´í„° íŒŒì¼ ì €ì¥ ì™„ë£Œ:", csv_file))
      
    } else {
      log_msg("âŒ XML íŒŒì¼ì€ ë°›ì•˜ìœ¼ë‚˜ ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.")
    }
    
  }, error = function(e) {
    log_msg(paste("âš ï¸ íŒŒì‹± ì—ëŸ¬:", e$message))
    # ì‹¤íŒ¨ ì›ì¸ íŒŒì•…ì„ ìœ„í•´ ë‹¤ìš´ë¡œë“œëœ ë‚´ìš© ì¼ë¶€ ì¶œë ¥
    if(file.exists(temp_xml)) {
      lines <- readLines(temp_xml, n = 5)
      print(lines)
    }
  })
  
} else {
  log_msg("âŒ CURL ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨ (ì°¨ë‹¨ë¨)")
}
