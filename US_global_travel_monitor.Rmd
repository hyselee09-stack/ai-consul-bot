---
title: "Global Travel Monitor (API Mirror)"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
if (!require("pacman")) install.packages("pacman")
# API ë°ì´í„° ì²˜ë¦¬ë¥¼ ìœ„í•œ jsonlite íŒ¨í‚¤ì§€ í•„ìˆ˜
pacman::p_load(jsonlite, tidyverse, telegram.bot, readr, lubridate, httr)


TELEGRAM_BOT_TOKEN <- Sys.getenv("TELEGRAM_BOT_TOKEN")
MY_CHAT_ID         <- Sys.getenv("MY_CHAT_ID")
bot <- Bot(token = TELEGRAM_BOT_TOKEN)


print(paste("ğŸŒ [Global Watch]", Sys.time(), "API ë¯¸ëŸ¬ ì‚¬ì´íŠ¸ ì ‘ì† ì¤‘..."))

# [í•µì‹¬] êµ­ë¬´ë¶€ ë°ì´í„°ë¥¼ ë¯¸ëŸ¬ë§í•˜ëŠ” ì˜¤í”ˆ API ì£¼ì†Œ
api_url <- "[https://www.travel-advisory.info/api](https://www.travel-advisory.info/api)"
csv_file <- "travel_status_memory.csv"

# ë°ì´í„° ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
fetch_api_data <- function() {
  tryCatch({
    # 1. API ìš”ì²­ (í—¤ë”ë¥¼ ì¶”ê°€í•´ì„œ ë´‡ ì°¨ë‹¨ ë°©ì§€)
    response <- GET(
      api_url,
      add_headers("User-Agent" = "Mozilla/5.0 (compatible; TravelMonitorBot/1.0)")
    )
    
    # 2. ìƒíƒœ í™•ì¸
    if (status_code(response) != 200) {
      print(paste("âš ï¸ API ì ‘ì† ì‹¤íŒ¨:", status_code(response)))
      return(NULL)
    }
    
    # 3. JSON íŒŒì‹±
    json_content <- fromJSON(content(response, "text", encoding = "UTF-8"))
    
    # 4. ë°ì´í„° ì¶”ì¶œ (ë³µì¡í•œ ë¦¬ìŠ¤íŠ¸ êµ¬ì¡°ë¥¼ ë°ì´í„°í”„ë ˆì„ìœ¼ë¡œ ë³€í™˜)
    # ì´ APIëŠ” êµ­ê°€ ì½”ë“œê°€ Keyë¡œ ë˜ì–´ ìˆì–´ì„œ ë¦¬ìŠ¤íŠ¸ë¥¼ í’€ì–´ì•¼ í•¨
    raw_data <- json_content$data
    
    # purrr íŒ¨í‚¤ì§€ë¡œ ë¦¬ìŠ¤íŠ¸ -> ë°ì´í„°í”„ë ˆì„ ë³€í™˜
    clean_df <- map_dfr(raw_data, function(x) {
      tibble(
        Country = x$name,
        # ì ìˆ˜: 0(ì•ˆì „) ~ 5(ìœ„í—˜). êµ­ë¬´ë¶€ ë“±ê¸‰ì„ ì ìˆ˜í™”í•œ ê²ƒ
        Score = as.numeric(x$advisory$score),
        # êµ­ë¬´ë¶€ ì›ë³¸ ì—…ë°ì´íŠ¸ ë‚ ì§œ
        Update_Date = as_datetime(x$advisory$updated)
      )
    }) %>%
      select(Country, Score) %>%
      filter(!is.na(Score))
    
    return(clean_df)
    
  }, error = function(e) {
    print(paste("âš ï¸ ì—ëŸ¬ ë°œìƒ:", e$message))
    return(NULL)
  })
}

# --- ë©”ì¸ ì‹¤í–‰ ---

current_data <- fetch_api_data()

if (!is.null(current_data) && nrow(current_data) > 0) {
  print(paste("âœ… ë°ì´í„° ìˆ˜ì§‘ ì„±ê³µ! ì´", nrow(current_data), "ê°œêµ­ í™•ì¸."))
  
  # ê³¼ê±° ë°ì´í„° ë¹„êµ
  if (file.exists(csv_file)) {
    past_data <- read_csv(csv_file, show_col_types = FALSE)
    
    # êµ­ê°€ëª… ê¸°ì¤€ìœ¼ë¡œ ë¹„êµ
    comparison <- current_data %>%
      inner_join(past_data, by = "Country", suffix = c("_new", "_old")) %>%
      filter(Score_new != Score_old) # ì ìˆ˜ê°€ ë°”ë€ ê²½ìš°
      
    if (nrow(comparison) > 0) {
      for(i in 1:nrow(comparison)) {
        row <- comparison[i, ]
        
        # ì ìˆ˜ ë³€í™” ê³„ì‚°
        diff <- row$Score_new - row$Score_old
        
        if (diff > 0) {
           emoji <- "ğŸ“‰ (ì•…í™”)"
           status_msg <- paste0("ìœ„í—˜ë„ ì¦ê°€ (+", round(diff, 1), ")")
        } else {
           emoji <- "ğŸ“ˆ (í˜¸ì „)"
           status_msg <- paste0("ìƒí™© ê°œì„  (", round(diff, 1), ")")
        }
        
        # ì ìˆ˜ë¥¼ êµ­ë¬´ë¶€ Levelë¡œ ëŒ€ëµ í™˜ì‚° (ì°¸ê³ ìš©)
        level_est <- case_when(
          row$Score_new >= 4.5 ~ "â›” ê¸ˆì§€ (Lv.4)",
          row$Score_new >= 3.5 ~ "ğŸŸ  ì¬ê³  (Lv.3)",
          row$Score_new >= 2.5 ~ "ğŸŸ¡ ì£¼ì˜ (Lv.2)",
          TRUE ~ "ğŸ”µ ì•ˆì „ (Lv.1)"
        )
        
        msg <- paste0(
          "ğŸ‡ºğŸ‡¸ [ì•ˆì „ë“±ê¸‰ ë³€ê²½ ì•Œë¦¼]\n\n",
          "ğŸ³ï¸ êµ­ê°€: ", row$Country, "\n",
          emoji, " ìƒíƒœ: ", status_msg, "\n",
          "ğŸ”¢ ì ìˆ˜: ", row$Score_old, " â¡ï¸ ", row$Score_new, " (5ì  ë§Œì )\n",
          "ğŸ“Š ì¶”ì • ë“±ê¸‰: ", level_est, "\n",
          "ğŸ”— ì¶œì²˜: travel-advisory.info"
        )
        
        try(bot$sendMessage(chat_id = MY_CHAT_ID, text = msg))
        Sys.sleep(1)
      }
      print(paste("âœ… ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ:", nrow(comparison), "ê±´"))
    } else {
      print("   -> ë³€ë™ ì‚¬í•­ ì—†ìŒ.")
    }
  } else {
    print("   -> [ì´ˆê¸°í™”] ì²« ì‹¤í–‰. ê¸°ì¤€ ë°ì´í„° ì €ì¥.")
    try(bot$sendMessage(chat_id = MY_CHAT_ID, text = "âœ… [ì—¬í–‰ê²½ë³´] API ë°©ì‹ ì´ˆê¸°í™” ì™„ë£Œ."))
  }
  
  # íŒŒì¼ ì €ì¥
  write_csv(current_data, csv_file)
  print(paste("ğŸ’¾ ë°ì´í„° ì €ì¥ ì™„ë£Œ:", csv_file))

} else {
  print("âŒ ë°ì´í„° ìˆ˜ì§‘ ì‹¤íŒ¨ (API ì˜¤ë¥˜)")
}
