---
title: "US Global Travel Advisory Monitor (Proxy Method)"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
if (!require("pacman")) install.packages("pacman")
# [ì¤‘ìš”] jsonlite íŒ¨í‚¤ì§€ ì‚¬ìš© (ì¤‘ê³„ ì„œë²„ ë°ì´í„° ì²˜ë¦¬ìš©)
pacman::p_load(jsonlite, tidyverse, telegram.bot, lubridate, stringr, readr)


TELEGRAM_BOT_TOKEN <- Sys.getenv("TELEGRAM_BOT_TOKEN")
MY_CHAT_ID         <- Sys.getenv("MY_CHAT_ID")
bot <- Bot(token = TELEGRAM_BOT_TOKEN)


# ë¡œê·¸ í•¨ìˆ˜
log_msg <- function(msg) {
  message(paste0("[", Sys.time(), "] ", msg))
}

log_msg("ğŸŒ [Global Watch] ì¤‘ê³„ ì„œë²„ë¥¼ í†µí•œ ë°ì´í„° ìˆ˜ì§‘ ì‹œì‘...")

# [í•µì‹¬ ì „ëµ]
# ìš°ë¦¬ê°€ ì§ì ‘ ì ‘ì†í•˜ë©´ ì°¨ë‹¨ë‹¹í•˜ë¯€ë¡œ, 'rss2json.com'ì´ë¼ëŠ” ì¤‘ê³„ ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•©ë‹ˆë‹¤.
# êµ­ë¬´ë¶€ RSS ì£¼ì†Œ
target_rss <- "[https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/jcr:content/par/feed.rss](https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/jcr:content/par/feed.rss)"
# ì¤‘ê³„ ì„œë²„ ì£¼ì†Œ (ë¬´ë£Œ API)
proxy_url  <- paste0("[https://api.rss2json.com/v1/api.json?rss_url=](https://api.rss2json.com/v1/api.json?rss_url=)", URLencode(target_rss))

csv_file <- "travel_status_memory.csv"

# ë°ì´í„° ìˆ˜ì§‘ í•¨ìˆ˜
fetch_data_via_proxy <- function() {
  tryCatch({
    # 1. ì¤‘ê³„ ì„œë²„ì— ìš”ì²­ (JSON ë°ì´í„°ë¡œ ì˜´)
    json_data <- fromJSON(proxy_url)
    
    # 2. ì‘ë‹µ ìƒíƒœ í™•ì¸
    if (json_data$status != "ok") {
      log_msg("âš ï¸ ì¤‘ê³„ ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜")
      return(NULL)
    }
    
    # 3. ë°ì´í„° ì¶”ì¶œ
    items <- json_data$items
    
    # 4. ë°ì´í„° ì •ë¦¬
    clean_data <- items %>%
      select(title, link, pubDate) %>%
      rename(item_title = title, item_link = link) %>%
      mutate(
        # êµ­ê°€ëª… ì¶”ì¶œ
        Country = str_trim(str_extract(item_title, "^.*?(?=\\s-\\sLevel)")),
        # ë ˆë²¨ ìˆ«ì ì¶”ì¶œ
        Level_Num = as.numeric(str_extract(item_title, "(?<=Level\\s)[0-9]")),
        # ë ˆë²¨ í…ìŠ¤íŠ¸ ì¶”ì¶œ
        Level_Text = str_trim(str_extract(item_title, "(?<=Level\\s).*"))
      ) %>%
      filter(!is.na(Country) & !is.na(Level_Num)) %>%
      select(Country, Level_Num, Level_Text, item_link)
    
    return(clean_data)
    
  }, error = function(e) {
    log_msg(paste("âš ï¸ ì—ëŸ¬ ë°œìƒ:", e$message))
    return(NULL)
  })
}

# --- ì‹¤í–‰ ë¡œì§ ---

current_data <- fetch_data_via_proxy()

if (!is.null(current_data) && nrow(current_data) > 0) {
  log_msg(paste("âœ… ë°ì´í„° ìˆ˜ì§‘ ì„±ê³µ! ì´", nrow(current_data), "ê°œêµ­."))
  
  # ê³¼ê±° ë°ì´í„° ë¹„êµ
  if (file.exists(csv_file)) {
    past_data <- read_csv(csv_file, show_col_types = FALSE)
    
    comparison <- current_data %>%
      inner_join(past_data, by = "Country", suffix = c("_new", "_old")) %>%
      filter(Level_Num_new != Level_Num_old) 
      
    if (nrow(comparison) > 0) {
      for(i in 1:nrow(comparison)) {
        row <- comparison[i, ]
        
        if (row$Level_Num_new > row$Level_Num_old) {
           emoji <- "ğŸ“‰"
           status_msg <- "ìœ„í—˜ ì¦ê°€ (Worsened)"
        } else {
           emoji <- "ğŸ“ˆ"
           status_msg <- "ìƒí™© í˜¸ì „ (Improved)"
        }
        
        msg <- paste0(
          "ğŸ‡ºğŸ‡¸ [ì—¬í–‰ê²½ë³´ ë³€ê²½]\n\n",
          "ğŸ³ï¸ êµ­ê°€: ", row$Country, "\n",
          emoji, " ìƒíƒœ: ", status_msg, "\n",
          "ğŸ”¢ ë“±ê¸‰: Lv.", row$Level_Num_old, " â¡ï¸ Lv.", row$Level_Num_new, "\n",
          "ğŸ”— ë§í¬: ", row$item_link_new
        )
        try(bot$sendMessage(chat_id = MY_CHAT_ID, text = msg))
        Sys.sleep(1)
      }
      log_msg(paste("âœ… ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ:", nrow(comparison), "ê±´"))
    } else {
      log_msg("-> ë³€ë™ ì‚¬í•­ ì—†ìŒ.")
    }
  } else {
    log_msg("-> [ì´ˆê¸°í™”] ì²« ì‹¤í–‰. ë°ì´í„° íŒŒì¼ ìƒì„±.")
    try(bot$sendMessage(chat_id = MY_CHAT_ID, text = "âœ… [ì—¬í–‰ê²½ë³´] ì´ˆê¸° ë°ì´í„° ìˆ˜ì§‘ ì™„ë£Œ (Proxy ì‚¬ìš©)."))
  }
  
  # íŒŒì¼ ì €ì¥ (ì„±ê³µ ì‹œì—ë§Œ ìˆ˜í–‰ë¨)
  write_csv(current_data, csv_file)
  log_msg(paste("ğŸ’¾ íŒŒì¼ ì €ì¥ ì™„ë£Œ:", csv_file))

} else {
  log_msg("âŒ ìµœì¢… ì‹¤íŒ¨: ì¤‘ê³„ ì„œë²„ì—ì„œë„ ë°ì´í„°ë¥¼ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.")
}
