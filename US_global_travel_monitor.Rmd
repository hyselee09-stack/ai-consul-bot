---
title: "Global Travel Safety Monitor (API Method)"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
if (!require("pacman")) install.packages("pacman")
# [Key Package] jsonlite is required to parse data from the API
pacman::p_load(jsonlite, tidyverse, telegram.bot, readr, lubridate)


TELEGRAM_BOT_TOKEN <- Sys.getenv("TELEGRAM_BOT_TOKEN")
MY_CHAT_ID         <- Sys.getenv("MY_CHAT_ID")
bot <- Bot(token = TELEGRAM_BOT_TOKEN)


print(paste("ğŸŒ [Global Watch]", Sys.time(), "Starting API Scan..."))

# [STRATEGY CHANGE] Use the open API which mirrors State Dept data
# This avoids IP blocking issues.
api_url <- "[https://www.travel-advisory.info/api](https://www.travel-advisory.info/api)"
csv_file <- "travel_status_memory.csv"

tryCatch({
  # 1. Fetch Data from API (JSON format)
  json_data <- fromJSON(api_url)
  
  # 2. Process Data (Convert complex list to Data Frame)
  # The API returns a score (0-5). Higher is more dangerous.
  raw_list <- json_data$data
  
  current_data <- map_dfr(raw_list, function(x) {
    tibble(
      Country = x$name,
      Score = as.numeric(x$advisory$score), # 0 (Safe) to 5 (Dangerous)
      Update_Date = as_datetime(x$advisory$updated)
    )
  }) %>%
    select(Country, Score) %>%
    arrange(desc(Score))
  
  print(paste("âœ… API Fetch Success! Checked", nrow(current_data), "countries."))

  # 3. Compare with Previous Data
  if (file.exists(csv_file)) {
    past_data <- read_csv(csv_file, show_col_types = FALSE)
    
    # Logic: Compare Scores
    comparison <- current_data %>%
      inner_join(past_data, by = "Country", suffix = c("_new", "_old")) %>%
      filter(Score_new != Score_old) # Filter changed scores
      
    if (nrow(comparison) > 0) {
      for(i in 1:nrow(comparison)) {
        row <- comparison[i, ]
        
        # Determine Direction
        diff <- row$Score_new - row$Score_old
        if (diff > 0) {
           emoji <- "ğŸ“‰ (Worsened)"
           status_msg <- paste0("Risk Increased (+", round(diff, 1), ")")
        } else {
           emoji <- "ğŸ“ˆ (Improved)"
           status_msg <- paste0("Situation Improved (", round(diff, 1), ")")
        }
        
        # Estimate Level based on Score
        level_est <- case_when(
          row$Score_new >= 4.5 ~ "â›” Do Not Travel (Lv.4)",
          row$Score_new >= 3.5 ~ "ğŸŸ  Reconsider (Lv.3)",
          row$Score_new >= 2.5 ~ "ğŸŸ¡ Caution (Lv.2)",
          TRUE ~ "ğŸ”µ Normal (Lv.1)"
        )
        
        msg <- paste0(
          "ğŸŒ [Safety Score Update]\n\n",
          "ğŸ³ï¸ Country: ", row$Country, "\n",
          emoji, " Status: ", status_msg, "\n",
          "ğŸ”¢ Score: ", row$Score_old, " â¡ï¸ ", row$Score_new, " / 5.0\n",
          "ğŸ“Š Est. Level: ", level_est, "\n",
          "ğŸ”— Source: travel-advisory.info"
        )
        
        try(bot$sendMessage(chat_id = MY_CHAT_ID, text = msg))
        Sys.sleep(1)
      }
      print(paste("âœ… Sent alerts for", nrow(comparison), "changed countries."))
    } else {
      print("   -> No score changes detected.")
    }
  } else {
    print("   -> [Init] First run. Saving baseline data.")
    try(bot$sendMessage(chat_id = MY_CHAT_ID, text = "âœ… [Travel Monitor] Initial API data collected."))
  }
  
  # 4. Save Data (Crucial for the YAML commit step)
  write_csv(current_data, csv_file)
  print(paste("ğŸ’¾ Data saved to:", csv_file))

}, error = function(e) {
  print(paste("âŒ Error:", e$message))
})
