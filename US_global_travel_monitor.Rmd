---
title: "US Global Travel Advisory Monitor (System Curl Impersonation)"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
if (!require("pacman")) install.packages("pacman")
pacman::p_load(rvest, tidyverse, telegram.bot, lubridate, stringr, readr)


TELEGRAM_BOT_TOKEN <- Sys.getenv("TELEGRAM_BOT_TOKEN")
MY_CHAT_ID         <- Sys.getenv("MY_CHAT_ID")
bot <- Bot(token = TELEGRAM_BOT_TOKEN)


log_msg <- function(msg) {
  message(paste0("[", Sys.time(), "] ", msg))
}

log_msg("ğŸŒ [Global Watch] ì‹œìŠ¤í…œ CURLì„ ì´ìš©í•œ ì •ë°€ íƒ€ê²© ì‹œì‘...")

# [Target] RSSê°€ ì•„ë‹Œ 'ì¼ë°˜ ì›¹í˜ì´ì§€' (ë³´ì•ˆì´ ìƒëŒ€ì ìœ¼ë¡œ ë‚®ìŒ)
target_url <- "[https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories.html](https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories.html)"
temp_file  <- "downloaded_page.html"
csv_file   <- "travel_status_memory.csv"

# [í•µì‹¬ ì „ëµ] ë¦¬ëˆ…ìŠ¤ ì‹œìŠ¤í…œì˜ curl ëª…ë ¹ì–´ë¡œ ë¸Œë¼ìš°ì € ì™„ë²½ í‰ë‚´
download_html_system <- function(url, dest) {
  # ì‹¤ì œ í¬ë¡¬ ë¸Œë¼ìš°ì €ê°€ ë³´ë‚´ëŠ” í—¤ë”ë¥¼ ê·¸ëŒ€ë¡œ ë³µì‚¬
  cmd <- paste0(
    "curl -s -L ", # ì¡°ìš©íˆ(-s), ë¦¬ë‹¤ì´ë ‰íŠ¸ ì¶”ì (-L)
    "-A 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36' ",
    "-H 'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8' ",
    "-H 'Accept-Language: en-US,en;q=0.9' ",
    "-H 'Cache-Control: max-age=0' ",
    "-H 'Connection: keep-alive' ",
    "-H 'Upgrade-Insecure-Requests: 1' ",
    "-H 'Sec-Fetch-Dest: document' ",
    "-H 'Sec-Fetch-Mode: navigate' ",
    "-H 'Sec-Fetch-Site: none' ",
    "-H 'Sec-Fetch-User: ?1' ",
    "-o ", dest, " ",
    "'", url, "'"
  )
  
  log_msg("ğŸ“¡ ì‹œìŠ¤í…œ CURL ëª…ë ¹ ì‹¤í–‰ ì¤‘...")
  exit_code <- system(cmd)
  
  # íŒŒì¼ì´ ì¡´ì¬í•˜ê³  ìš©ëŸ‰ì´ 1KB ì´ìƒì´ì–´ì•¼ ì„±ê³µ
  if (exit_code == 0 && file.exists(dest) && file.info(dest)$size > 1000) {
    return(TRUE)
  } else {
    return(FALSE)
  }
}

# --- ì‹¤í–‰ ë¡œì§ ---

if (download_html_system(target_url, temp_file)) {
  log_msg("âœ… HTML ë‹¤ìš´ë¡œë“œ ì„±ê³µ! ë°ì´í„° íŒŒì‹± ì‹œì‘.")
  
  tryCatch({
    # 1. ë‹¤ìš´ë¡œë“œí•œ íŒŒì¼ ì½ê¸°
    page <- read_html(temp_file)
    
    # 2. í…Œì´ë¸” ì¶”ì¶œ (ì›¹í˜ì´ì§€ êµ¬ì¡° ë¶„ì„)
    # data-table í´ë˜ìŠ¤ë¥¼ ê°€ì§„ í…Œì´ë¸”ì„ ì°¾ìŒ
    raw_table <- page %>% 
      html_element("table") %>% 
      html_table()
    
    if (nrow(raw_table) > 0) {
      # 3. ë°ì´í„° ì •ì œ
      current_data <- raw_table %>%
        select(Advisory, Level, Date) %>%
        rename(Country = Advisory, Level_Text = Level, Date_Str = Date) %>%
        mutate(
          Country = str_remove(Country, " Travel Advisory"),
          Level_Num = as.numeric(str_extract(Level_Text, "[0-9]")),
          # ë‚ ì§œ íŒŒì‹± (ì˜ˆ: October 20, 2023)
          Pub_Date = mdy(Date_Str),
          Link = target_url
        ) %>%
        filter(!is.na(Country) & !is.na(Level_Num))
      
      log_msg(paste("ğŸ“Š ì¶”ì¶œëœ êµ­ê°€ ìˆ˜:", nrow(current_data)))

      # 4. ê³¼ê±° ë°ì´í„° ë¹„êµ
      if (file.exists(csv_file)) {
        past_data <- read_csv(csv_file, show_col_types = FALSE)
        
        comparison <- current_data %>%
          inner_join(past_data, by = "Country", suffix = c("_new", "_old")) %>%
          filter(Level_Num_new != Level_Num_old) 
          
        if (nrow(comparison) > 0) {
          for(i in 1:nrow(comparison)) {
            row <- comparison[i, ]
            emoji <- ifelse(row$Level_Num_new > row$Level_Num_old, "ğŸ“‰", "ğŸ“ˆ")
            msg <- paste0(
              "ğŸ‡ºğŸ‡¸ [ì—¬í–‰ê²½ë³´ ë³€ê²½]\n\n",
              "ğŸ³ï¸ êµ­ê°€: ", row$Country, "\n",
              emoji, " ë“±ê¸‰: Lv.", row$Level_Num_old, " â¡ï¸ Lv.", row$Level_Num_new, "\n",
              "ğŸ“… ë‚ ì§œ: ", row$Date_Str_new, "\n",
              "ğŸ”— í™•ì¸: ", target_url
            )
            try(bot$sendMessage(chat_id = MY_CHAT_ID, text = msg))
            Sys.sleep(1)
          }
          log_msg(paste("âœ… ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ:", nrow(comparison), "ê±´"))
        } else {
          log_msg("-> ë³€ë™ ì‚¬í•­ ì—†ìŒ.")
        }
      } else {
        log_msg("-> [ì´ˆê¸°í™”] ì²« ì‹¤í–‰. ë°ì´í„° íŒŒì¼ ìƒì„±.")
        try(bot$sendMessage(chat_id = MY_CHAT_ID, text = "âœ… [ì—¬í–‰ê²½ë³´] ì´ˆê¸°í™” ì™„ë£Œ (CURL ë°©ì‹)."))
      }
      
      # íŒŒì¼ ì €ì¥ (ì„±ê³µ ì‹œì—ë§Œ)
      write_csv(current_data, csv_file)
      log_msg(paste("ğŸ’¾ íŒŒì¼ ì €ì¥ ì™„ë£Œ:", csv_file))
      
    } else {
      log_msg("âŒ í…Œì´ë¸”ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ì›¹ì‚¬ì´íŠ¸ êµ¬ì¡° ë³€ê²½ ê°€ëŠ¥ì„±)")
    }
    
  }, error = function(e) {
    log_msg(paste("âš ï¸ íŒŒì‹± ì—ëŸ¬:", e$message))
  })
  
} else {
  log_msg("âŒ CURL ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨ (ì—¬ì „íˆ ì°¨ë‹¨ë¨)")
}
