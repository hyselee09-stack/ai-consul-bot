---
title: "US Global Travel Advisory Monitor (With Memory)"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
if (!require("pacman")) install.packages("pacman")
pacman::p_load(httr, tidyRSS, tidyverse, telegram.bot, lubridate, stringr, readr, xml2)


TELEGRAM_BOT_TOKEN <- Sys.getenv("TELEGRAM_BOT_TOKEN")
MY_CHAT_ID         <- Sys.getenv("MY_CHAT_ID")
bot <- Bot(token = TELEGRAM_BOT_TOKEN)


# ë©”ì‹œì§€ë¥¼ ê°•ì œë¡œ ì¶œë ¥í•˜ëŠ” í•¨ìˆ˜ (ë¡œê·¸ í™•ì¸ìš©)
log_msg <- function(msg) {
  message(paste0("[", Sys.time(), "] ", msg))
}

log_msg("ğŸŒ [Global Watch] ì—¬í–‰ ê²½ë³´ ìŠ¤ìº” ì‹œì‘...")

# [ìˆ˜ì • 1] HTTPS ì£¼ì†Œ ì‚¬ìš©
feed_url <- "[https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/jcr:content/par/feed.rss](https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/jcr:content/par/feed.rss)"
csv_file <- "travel_status_memory.csv"

# [í•µì‹¬ ìˆ˜ì •] ê°•ë ¥í•œ ì°¨ë‹¨ ìš°íšŒ í•¨ìˆ˜
fetch_feed_safe <- function(url) {
  tryCatch({
    # [ìˆ˜ì • 2] SSL ê²€ì¦ ë¹„í™œì„±í™” ë° ì •êµí•œ í—¤ë” ì„¤ì •
    response <- GET(
      url, 
      config = config(ssl_verifypeer = 0L), # SSL ì—ëŸ¬ ë°©ì§€
      add_headers(
        "User-Agent" = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",
        "Accept" = "application/rss+xml, application/xml, text/xml, */*"
      ),
      timeout(30) # 30ì´ˆ ê¸°ë‹¤ë ¤ì¤Œ
    )
    
    log_msg(paste("ì ‘ì† ìƒíƒœ ì½”ë“œ:", status_code(response)))
    
    if (status_code(response) != 200) {
      log_msg("âš ï¸ ì ‘ì† ì‹¤íŒ¨! (ì°¨ë‹¨ë¨)")
      return(NULL)
    }
    
    # ë‚´ìš© íŒŒì‹±
    content_text <- content(response, "text", encoding = "UTF-8")
    return(tidyRSS::tidyfeed(content_text))
    
  }, error = function(e) {
    log_msg(paste("âš ï¸ ë„¤íŠ¸ì›Œí¬/íŒŒì‹± ì—ëŸ¬:", e$message))
    return(NULL)
  })
}

# --- ë©”ì¸ ë¡œì§ ---

feed <- fetch_feed_safe(feed_url)

if (!is.null(feed) && nrow(feed) > 0) {
  log_msg(paste("âœ… ë°ì´í„° ìˆ˜ì§‘ ì„±ê³µ:", nrow(feed), "ê°œ í•­ëª©"))
  
  # ë°ì´í„° ì •ì œ
  current_data <- feed %>%
    select(item_title, item_link) %>%
    mutate(
      Country = str_trim(str_extract(item_title, "^.*?(?=\\s-\\sLevel)")),
      Level_Num = as.numeric(str_extract(item_title, "(?<=Level\\s)[0-9]")),
      Level_Text = str_trim(str_extract(item_title, "(?<=Level\\s).*"))
    ) %>%
    filter(!is.na(Country) & !is.na(Level_Num)) %>%
    select(Country, Level_Num, Level_Text, item_link)

  # ê³¼ê±° ë°ì´í„° ë¹„êµ
  if (file.exists(csv_file)) {
    past_data <- read_csv(csv_file, show_col_types = FALSE)
    
    comparison <- current_data %>%
      inner_join(past_data, by = "Country", suffix = c("_new", "_old")) %>%
      filter(Level_Num_new != Level_Num_old) 
      
    if (nrow(comparison) > 0) {
      for(i in 1:nrow(comparison)) {
        row <- comparison[i, ]
        emoji <- ifelse(row$Level_Num_new > row$Level_Num_old, "ğŸ“‰", "ğŸ“ˆ")
        status_msg <- ifelse(row$Level_Num_new > row$Level_Num_old, "ìœ„í—˜ ì¦ê°€", "ìƒí™© í˜¸ì „")
        
        msg <- paste0(
          "ğŸ‡ºğŸ‡¸ [ì—¬í–‰ê²½ë³´ ë³€ê²½]\n\n",
          "ğŸ³ï¸ êµ­ê°€: ", row$Country, "\n",
          emoji, " ìƒíƒœ: ", status_msg, "\n",
          "ğŸ”¢ ë“±ê¸‰: Lv.", row$Level_Num_old, " â¡ï¸ Lv.", row$Level_Num_new, "\n",
          "ğŸ”— ë§í¬: ", row$item_link_new
        )
        try(bot$sendMessage(chat_id = MY_CHAT_ID, text = msg))
        Sys.sleep(1)
      }
      log_msg(paste("âœ… ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ:", nrow(comparison), "ê±´"))
    } else {
      log_msg("-> ë³€ë™ ì‚¬í•­ ì—†ìŒ.")
    }
  } else {
    log_msg("-> [ì´ˆê¸°í™”] ì²« ì‹¤í–‰. ë°ì´í„° íŒŒì¼ ìƒì„±.")
  }
  
  # íŒŒì¼ ì €ì¥
  write_csv(current_data, csv_file)
  log_msg(paste("ğŸ’¾ íŒŒì¼ ì €ì¥ ì™„ë£Œ:", csv_file))

} else {
  log_msg("âŒ ìµœì¢… ì‹¤íŒ¨: ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í•´ íŒŒì¼ì„ ìƒì„±í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")
}
