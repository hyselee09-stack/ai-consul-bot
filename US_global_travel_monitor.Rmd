---
title: "US Global Travel Advisory Monitor (AllOrigins Proxy)"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
if (!require("pacman")) install.packages("pacman")
# xml2ì™€ httr íŒ¨í‚¤ì§€ê°€ í•µì‹¬ì…ë‹ˆë‹¤
pacman::p_load(httr, tidyRSS, tidyverse, telegram.bot, lubridate, stringr, readr, xml2)


TELEGRAM_BOT_TOKEN <- Sys.getenv("TELEGRAM_BOT_TOKEN")
MY_CHAT_ID         <- Sys.getenv("MY_CHAT_ID")
bot <- Bot(token = TELEGRAM_BOT_TOKEN)


# ë¡œê·¸ í•¨ìˆ˜
log_msg <- function(msg) {
  message(paste0("[", Sys.time(), "] ", msg))
}

log_msg("ğŸŒ [Global Watch] AllOrigins í”„ë¡ì‹œë¥¼ í†µí•œ ì ‘ì† ì‹œë„...")

# êµ­ë¬´ë¶€ RSS ì›ë³¸ ì£¼ì†Œ
target_rss <- "[https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/jcr:content/par/feed.rss](https://travel.state.gov/content/travel/en/traveladvisories/traveladvisories/jcr:content/par/feed.rss)"
csv_file <- "travel_status_memory.csv"

# [í•µì‹¬ ì „ëµ] AllOrigins í”„ë¡ì‹œ ì‚¬ìš© + íƒ€ì„ìŠ¤íƒ¬í”„ë¡œ ìºì‹œ ë°©ì§€
# ì´ ì£¼ì†Œë¥¼ í†µí•˜ë©´ ìš”ì²­ìê°€ 'GitHub'ê°€ ì•„ë‹ˆë¼ 'AllOrigins'ê°€ ë©ë‹ˆë‹¤.
proxy_url <- paste0(
  "[https://api.allorigins.win/raw?url=](https://api.allorigins.win/raw?url=)", URLencode(target_rss),
  "&disableCache=", as.numeric(Sys.time()) # ë§¤ë²ˆ ìƒˆë¡œìš´ ìš”ì²­ì²˜ëŸ¼ ë³´ì´ê²Œ í•¨
)

# ë°ì´í„° ìˆ˜ì§‘ í•¨ìˆ˜
fetch_feed_proxy <- function() {
  tryCatch({
    # 1. í”„ë¡ì‹œ ì„œë²„ì— ìš”ì²­
    response <- GET(proxy_url, timeout(60))
    
    # 2. ìƒíƒœ í™•ì¸
    if (status_code(response) != 200) {
      log_msg(paste("âš ï¸ í”„ë¡ì‹œ ì„œë²„ ì˜¤ë¥˜:", status_code(response)))
      return(NULL)
    }
    
    # 3. XML ë‚´ìš© íŒŒì‹± (Raw Text -> XML -> Tidy Frame)
    xml_content <- content(response, "text", encoding = "UTF-8")
    
    # ë‚´ìš©ì´ ë¹„ì–´ìˆëŠ”ì§€ í™•ì¸
    if (nchar(xml_content) < 100) {
      log_msg("âš ï¸ ë¹ˆ ë°ì´í„°ê°€ ë°˜í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.")
      return(NULL)
    }
    
    # tidyRSSë¡œ ë³€í™˜
    return(tidyRSS::tidyfeed(xml_content))
    
  }, error = function(e) {
    log_msg(paste("âš ï¸ ì—ëŸ¬ ë°œìƒ:", e$message))
    return(NULL)
  })
}

# --- ì‹¤í–‰ ë¡œì§ ---

feed <- fetch_feed_proxy()

if (!is.null(feed) && nrow(feed) > 0) {
  log_msg(paste("âœ… ë°ì´í„° ìˆ˜ì§‘ ì„±ê³µ! ì´", nrow(feed), "ê°œêµ­ í™•ì¸."))
  
  # ë°ì´í„° ì •ì œ
  current_data <- feed %>%
    select(item_title, item_link) %>%
    mutate(
      Country = str_trim(str_extract(item_title, "^.*?(?=\\s-\\sLevel)")),
      Level_Num = as.numeric(str_extract(item_title, "(?<=Level\\s)[0-9]")),
      Level_Text = str_trim(str_extract(item_title, "(?<=Level\\s).*"))
    ) %>%
    filter(!is.na(Country) & !is.na(Level_Num)) %>%
    select(Country, Level_Num, Level_Text, item_link)

  # ê³¼ê±° ë°ì´í„° ë¹„êµ
  if (file.exists(csv_file)) {
    past_data <- read_csv(csv_file, show_col_types = FALSE)
    
    comparison <- current_data %>%
      inner_join(past_data, by = "Country", suffix = c("_new", "_old")) %>%
      filter(Level_Num_new != Level_Num_old) 
      
    if (nrow(comparison) > 0) {
      for(i in 1:nrow(comparison)) {
        row <- comparison[i, ]
        emoji <- ifelse(row$Level_Num_new > row$Level_Num_old, "ğŸ“‰", "ğŸ“ˆ")
        status_msg <- ifelse(row$Level_Num_new > row$Level_Num_old, "ìœ„í—˜ ì¦ê°€", "ìƒí™© í˜¸ì „")
        
        msg <- paste0(
          "ğŸ‡ºğŸ‡¸ [ì—¬í–‰ê²½ë³´ ë³€ê²½]\n\n",
          "ğŸ³ï¸ êµ­ê°€: ", row$Country, "\n",
          emoji, " ìƒíƒœ: ", status_msg, "\n",
          "ğŸ”¢ ë“±ê¸‰: Lv.", row$Level_Num_old, " â¡ï¸ Lv.", row$Level_Num_new, "\n",
          "ğŸ”— ë§í¬: ", row$item_link_new
        )
        try(bot$sendMessage(chat_id = MY_CHAT_ID, text = msg))
        Sys.sleep(1)
      }
      log_msg(paste("âœ… ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ:", nrow(comparison), "ê±´"))
    } else {
      log_msg("-> ë³€ë™ ì‚¬í•­ ì—†ìŒ.")
    }
  } else {
    log_msg("-> [ì´ˆê¸°í™”] ì²« ì‹¤í–‰. ë°ì´í„° íŒŒì¼ ìƒì„±.")
    try(bot$sendMessage(chat_id = MY_CHAT_ID, text = "âœ… [ì—¬í–‰ê²½ë³´] AllOrigins ìš°íšŒ ë°©ì‹ìœ¼ë¡œ ë°ì´í„° ìˆ˜ì§‘ ì„±ê³µ."))
  }
  
  # íŒŒì¼ ì €ì¥ (ì„±ê³µ ì‹œì—ë§Œ)
  write_csv(current_data, csv_file)
  log_msg(paste("ğŸ’¾ íŒŒì¼ ì €ì¥ ì™„ë£Œ:", csv_file))

} else {
  log_msg("âŒ ìµœì¢… ì‹¤íŒ¨: ëª¨ë“  ìš°íšŒ ìˆ˜ë‹¨ì´ ë§‰í˜”ìŠµë‹ˆë‹¤.")
}
